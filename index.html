<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Multiplayer</title>
    <title>IMVU Clone - Robot Edition</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* GLOBAL RESET */
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Arial', sans-serif; color: white; }
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Arial', sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; }

        /* UI OVERLAYS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        #imvu-chat-panel { pointer-events: auto; width: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; border-top: 2px solid #333; transition: height 0.3s; }
        #exit-btn { pointer-events: auto; position: absolute; top: 10px; right: 10px; background: #d32f2f; color: white; border: 1px solid #fff; padding: 5px 10px; font-weight: bold; font-size: 12px; z-index: 200; }
        #imvu-chat-panel { pointer-events: auto; width: 100%; background-color: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; border-top: 1px solid #444; transition: height 0.3s; backdrop-filter: blur(5px); }
        #exit-btn { pointer-events: auto; position: absolute; top: 15px; right: 15px; background: #ff4444; color: white; border: none; border-radius: 4px; padding: 8px 15px; font-weight: bold; font-size: 12px; z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.2s; }
        #exit-btn:hover { background: #ff2222; transform: scale(1.05); }

        /* --- BATTLE HUD --- */
        #battle-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 450px; background: rgba(0,0,0,0.9); border: 2px solid #ffd700;
            border-radius: 8px; padding: 10px; z-index: 200; pointer-events: auto;
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 450px; background: rgba(10, 10, 20, 0.9); border: 1px solid #00e5ff;
            border-radius: 8px; padding: 15px; z-index: 200; pointer-events: auto;
            text-align: center; display: none; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
            backdrop-filter: blur(4px);
        }
        .hud-title { color: #ffd700; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .hud-title { color: #00e5ff; font-weight: bold; font-size: 16px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 5px #00e5ff; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: monospace; font-size: 14px; }
        .score-box { width: 45%; background: #222; padding: 5px; border: 1px solid #444; border-radius: 4px; }
        .score-val { font-size: 24px; font-weight: bold; color: #fff; }
        .mps-val { font-size: 11px; color: #aaa; }
        .control-row { margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; color: #888; font-size: 11px; }

        .score-box { width: 45%; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; border: 1px solid #333; }
        .score-val { font-size: 26px; font-weight: bold; color: #fff; margin-top: 5px; }
        .mps-val { font-size: 11px; color: #888; margin-top: 2px; }
        
        /* --- 3D CHAT BUBBLES --- */
        .chat-bubble {
            position: absolute; background: white; color: black; padding: 4px 8px; border-radius: 8px;
            font-size: 11px; font-weight: bold; font-family: 'Verdana', sans-serif;
            border: 1px solid #000; box-shadow: 2px 2px 0px rgba(0,0,0,0.3);
            pointer-events: none; white-space: nowrap; z-index: 5; 
            animation: floatUp 1.5s forwards; opacity: 0.9;
            position: absolute; background: rgba(255, 255, 255, 0.95); color: #000; padding: 6px 12px; border-radius: 12px;
            font-size: 12px; font-weight: bold; font-family: 'Verdana', sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: none; white-space: nowrap; z-index: 5; 
            animation: floatUp 2.5s forwards; transform-origin: center bottom;
        }
        .chat-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0; border-style: solid; border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent; }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 0.9; }
            100% { transform: translateY(-100px) scale(0.8); opacity: 0; }
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            10% { transform: translateY(-10px) scale(1.05); opacity: 1; }
            20% { transform: translateY(-10px) scale(1); opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-80px) scale(0.9); opacity: 0; }
        }

        /* --- AVATAR MENU --- */
        #avatar-menu {
            display: none; position: absolute; width: 200px;
            background-color: rgba(0, 0, 0, 0.9); border: 1px solid #555;
            border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.8);
            display: none; position: absolute; width: 180px;
            background-color: rgba(20, 20, 30, 0.95); border: 1px solid #444;
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            font-family: 'Segoe UI', sans-serif; font-size: 13px;
            z-index: 150; pointer-events: auto; color: #ddd;
            z-index: 150; pointer-events: auto; color: #ccc; overflow: hidden;
        }
        .menu-header { background-color: #111; padding: 6px 10px; display: flex; align-items: center; border-bottom: 1px solid #444; font-weight: bold; font-size: 14px; cursor: move; user-select: none; }
        .close-menu { margin-left: auto; cursor: pointer; color: #888; font-size: 16px; }
        .action-item { padding: 8px 15px; cursor: pointer; color: #eee; border-bottom: 1px solid #222; }
        .action-item:hover { background-color: #333; color: #fff; }
        .menu-header { background: linear-gradient(90deg, #222, #333); padding: 8px 12px; display: flex; align-items: center; border-bottom: 1px solid #444; font-weight: bold; color: white; }
        .close-menu { margin-left: auto; cursor: pointer; color: #aaa; } .close-menu:hover { color: white; }
        .action-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; transition: 0.2s; }
        .action-item:hover { background-color: #00e5ff; color: #000; }

        /* AUTH & DASHBOARD STYLES */
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 300px; padding: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid #444; border-radius: 8px; text-align: center; }
        .auth-input { width: 90%; padding: 10px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; }
        .auth-btn { width: 100%; padding: 10px; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: none; font-weight: bold; }
        .link-text { margin-top: 15px; font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 12px; margin-bottom: 10px; display: none; }
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a2e, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 320px; padding: 40px; background: rgba(255, 255, 255, 0.05); border: 1px solid #333; border-radius: 12px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .auth-input { width: 90%; padding: 12px; margin-bottom: 15px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; font-size: 14px; transition: 0.3s; }
        .auth-input:focus { border-color: #00e5ff; box-shadow: 0 0 8px rgba(0, 229, 255, 0.3); }
        .auth-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #00e5ff, #007ae5); border: none; font-weight: bold; color: white; border-radius: 6px; font-size: 16px; transition: 0.3s; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 122, 229, 0.4); }
        .link-text { margin-top: 20px; font-size: 13px; color: #888; cursor: pointer; text-decoration: none; }
        .link-text:hover { color: #fff; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 13px; margin-bottom: 15px; display: none; background: rgba(255,85,85,0.1); padding: 5px; border-radius: 4px; }

        #signup-view, #dashboard-view, #room-view { display: none; }
        #login-view { display: flex; }

        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 30% 50%, #2a2a2a, #000000); z-index: 50; }
        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #111, #000); z-index: 50; }
        #menu-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dashboard-btn { width: 150px; height: 120px; background: linear-gradient(to bottom, #555, #333 50%, #222); border: 1px solid #666; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .dashboard-btn:hover { filter: brightness(1.2); transform: scale(1.05); }
        .dashboard-btn { width: 160px; height: 140px; background: linear-gradient(145deg, #222, #151515); border: 1px solid #333; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .dashboard-btn:hover { border-color: #00e5ff; transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 229, 255, 0.15); }
        .btn-icon { font-size: 40px; margin-bottom: 10px; }
        .btn-text { font-size: 16px; color: #ccc; font-weight: bold; }

        /* CHAT CSS */
        #chat-interface-wrapper { display: block; }
        #chat-history { height: 200px; overflow-y: scroll; padding: 10px; font-size: 13px; line-height: 1.5; color: white; scrollbar-width: thin; scrollbar-color: #444 #111; }
        .chat-line { margin-bottom: 2px; font-family: 'Verdana', sans-serif; font-size: 12px; }
        .username { color: #8FBC8F; font-weight: bold; cursor: pointer; }
        .message-text { color: #e0e0e0; }
        .system-msg { color: #ffd700; font-style: italic; font-weight: bold; } 
        #input-row { display: flex; background-color: #111; padding: 4px; align-items: center; border-top: 1px solid #333; }
        #msgInput { flex-grow: 1; background-color: #222; border: 1px solid #555; color: white; padding: 5px 8px; font-size: 12px; outline: none; }
        #send-btn { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: 1px solid #c49000; color: black; font-weight: bold; font-size: 12px; padding: 5px 20px; margin-left: 5px; cursor: pointer; }
        #toolbar { height: 30px; background-color: #000; display: flex; align-items: center; border-bottom: 2px solid #b8860b; padding-left: 5px; }
        .icon { width: 35px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #888; cursor: pointer; user-select: none; }
        .icon.active { background: linear-gradient(to bottom, #ffd700, #ffb300); color: black; }
        #scroll-notice { position: absolute; bottom: 40px; right: 20px; background: #333; color: yellow; font-size: 10px; padding: 2px 5px; display: none; z-index: 500; border: 1px solid yellow; }
        #chat-interface-wrapper { display: block; padding: 10px; }
        #chat-history { height: 220px; overflow-y: scroll; margin-bottom: 10px; font-size: 13px; line-height: 1.6; color: #ddd; scrollbar-width: thin; scrollbar-color: #444 transparent; }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-thumb { background-color: #444; border-radius: 3px; }
        .chat-line { margin-bottom: 4px; text-shadow: 1px 1px 2px black; }
        .username { color: #00e5ff; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .message-text { color: #eee; }
        .system-msg { color: #ffd700; font-style: italic; opacity: 0.8; } 
        #input-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 5px 10px; border: 1px solid #444; }
        #msgInput { flex-grow: 1; background: transparent; border: none; color: white; padding: 8px; font-size: 13px; }
        #send-btn { background: #00e5ff; color: #000; border: none; font-weight: bold; font-size: 12px; padding: 8px 20px; border-radius: 20px; margin-left: 10px; transition: 0.2s; }
        #send-btn:hover { background: #fff; }
        #toolbar { height: 40px; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; padding-left: 15px; border-top: 1px solid #333; }
        .icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #888; cursor: pointer; transition: 0.2s; }
        .icon:hover { color: white; }
        .icon.active { color: #00e5ff; text-shadow: 0 0 10px #00e5ff; }
        #scroll-notice { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: #ff9800; color: black; font-weight: bold; font-size: 11px; padding: 4px 10px; border-radius: 10px; display: none; z-index: 500; }
    </style>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>

    <!-- BATTLE HUD -->
    <div id="battle-hud">
        <div class="hud-title">‚öîÔ∏è REAL-TIME CHAT HUD ‚öîÔ∏è</div>
        <div class="hud-title">Server Statistics</div>
        <div class="score-row">
            <div class="score-box" style="border-color: #00ff00;">
                <div style="color:#00ff00; font-size:11px;">YOU</div>
            <div class="score-box" style="border-color: #00e5ff;">
                <div style="color:#00e5ff; font-size:11px; font-weight:bold;">YOUR PACKETS</div>
                <div class="score-val" id="my-score">0</div>
                <div class="mps-val" id="my-mps">0 MPS</div>
            </div>
            <div class="score-box" style="border-color: #ff5555;">
                <div style="color:#ff5555; font-size:11px;">TOTAL SERVER CHAT</div>
                <div style="color:#ff5555; font-size:11px; font-weight:bold;">GLOBAL PACKETS</div>
                <div class="score-val" id="global-score">0</div>
            </div>
        </div>
        <div class="control-row">
            <p>Waiting for other players...</p>
            <button onclick="resetBattleScores()" style="background:#333; color:#fff; border:1px solid #555; padding:2px 10px; margin-top:5px; font-size:10px;">RESET STATS</button>
        <div class="control-row" style="margin-top:10px; font-size:11px; color:#aaa;">
            <p>Click floor to move. Click players for menu.</p>
            <button onclick="resetBattleScores()" style="background:transparent; color:#888; border:1px solid #555; padding:4px 10px; border-radius:4px; font-size:10px;">RESET STATS</button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">IMVU Classic Login</div>
            <div class="auth-title" style="font-size: 28px; color: white; font-weight: bold; margin-bottom: 25px;">IMVU: Robot World</div>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Sign In</button>
            <div class="link-text" onclick="showSignup()">Sign Up</div>
            <button class="auth-btn" onclick="handleLogin()">ENTER WORLD</button>
            <div class="link-text" onclick="showSignup()">Create new account</div>
        </div>
    </div>

    <!-- SIGNUP SCREEN -->
    <div id="signup-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">Create Account</div>
            <div class="auth-title" style="font-size: 28px; color: white; font-weight: bold; margin-bottom: 25px;">Join the Grid</div>
            <div id="signup-error" class="error-msg">Username taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="New Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="New Password">
            <button class="auth-btn" onclick="handleSignup()">Register</button>
            <input type="text" id="signup-user" class="auth-input" placeholder="Choose Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Create Password">
            <button class="auth-btn" onclick="handleSignup()">REGISTER</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="dashboard-view">
        <div id="menu-area">
            <div style="width: 450px; height: 60px; background: linear-gradient(to right, #500, #900); border: 1px solid #f00; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 10px rgba(255,0,0,0.5);">LOBBY</div>
            <h1 style="color:white; font-size: 40px; margin-bottom: 40px; text-shadow: 0 0 20px rgba(255,255,255,0.2);">WELCOME TO THE LOBBY</h1>
            <div id="button-grid">
                <div class="dashboard-btn" onclick="enterRoom()">
                    <div class="btn-icon">üè†üí¨</div>
                    <div class="btn-text">Enter Room</div>
                    <div class="btn-icon">ü§ñ</div>
                    <div class="btn-text">Connect to Server</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME ROOM -->
    <div id="room-view">
        <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:1;"></div>
        <!-- 3D Canvas -->
        <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; background:#000;"></div>

        <!-- Context Menu -->
        <div id="avatar-menu">
            <div class="menu-header" id="menu-header-handle">
                <span id="menu-username-display">Username</span> 
                <span id="menu-username-display">User</span> 
                <span class="close-menu" onclick="closeAvatarMenu()">‚úñ</span>
            </div>
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Trade</div>
            <div class="action-item" onclick="closeAvatarMenu()">Whisper</div>
        </div>

        <button id="exit-btn" onclick="exitRoom()">‚úñ EXIT ROOM</button>
        <button id="exit-btn" onclick="exitRoom()">‚úñ DISCONNECT</button>
        
        <!-- Chat UI -->
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div class="chat-header-bar"></div>
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="scroll-notice">VIEW PAUSED (Scroll down to resume)</div>
                    <div id="scroll-notice">‚á© New Messages Below ‚á©</div>
                    <div id="input-row">
                        <label style="margin-right:10px; color:#aaa; font-size:10px;"><input type="checkbox" id="focus-lock-check" checked> Lock Focus</label>
                        <input type="text" id="msgInput" placeholder="Chat here..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">Send</button>
                        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">SEND</button>
                    </div>
                    <div style="font-size:10px; color:#666; margin-top:5px; margin-left: 10px;">
                        <label><input type="checkbox" id="focus-lock-check" checked> Auto-focus chat</label>
                    </div>
                </div>
                <div id="toolbar">
@@ -181,9 +206,15 @@
        // --- SOCKET SETUP ---
        const socket = io();
        let currentUser = "Guest";
        let mySocketId = null;
        let mySocketId = null; 

        // --- AUTH ---
        // Capture my socket ID immediately upon connection
        socket.on('connect', () => {
            mySocketId = socket.id;
            console.log("Connected with ID:", mySocketId);
        });

        // --- AUTH LOGIC ---
        function showSignup() { document.getElementById('login-view').style.display='none'; document.getElementById('signup-view').style.display='flex'; }
        function showLogin() { document.getElementById('signup-view').style.display='none'; document.getElementById('login-view').style.display='flex'; }

@@ -193,47 +224,56 @@
            const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success){ currentUser=data.username; document.getElementById('login-view').style.display='none'; document.getElementById('dashboard-view').style.display='flex'; }
            else { document.getElementById('login-error').style.display='block'; document.getElementById('login-error').innerText=data.msg; }
            else { showError('login-error', data.msg); }
        }
        async function handleSignup() {
            const u = document.getElementById('signup-user').value;
            const p = document.getElementById('signup-pass').value;
            const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success) { alert("Registered!"); showLogin(); }
            else { document.getElementById('signup-error').style.display='block'; document.getElementById('signup-error').innerText=data.msg; }
            if(data.success) { alert("Registered! Please login."); showLogin(); }
            else { showError('signup-error', data.msg); }
        }
        function showError(id, msg) {
            const el = document.getElementById(id);
            el.style.display = 'block'; el.innerText = msg;
            setTimeout(() => el.style.display='none', 3000);
        }

        // --- ROOM LOGIC ---
        // --- ROOM MANAGEMENT ---
        const dashboard = document.getElementById('dashboard-view');
        const room = document.getElementById('room-view');
        const battleHud = document.getElementById('battle-hud');

        function enterRoom() {
            dashboard.style.display='none'; room.style.display='block'; battleHud.style.display='block';
            onWindowResize();
            // Tell server we are joining
            
            // Join logic:
            // 1. Tell server we are here.
            // 2. Server should reply with 'init players' (list of everyone)
            socket.emit('join game', currentUser);
            
            // Start stats
            setInterval(calculateMPS, 1000);
        }
        function exitRoom() { location.reload(); }

        let isChatOpen = true;
        function toggleChatWindow() {
            const wrapper = document.getElementById('chat-interface-wrapper');
            if(isChatOpen) { wrapper.style.display='none'; isChatOpen=false; }
            else { wrapper.style.display='block'; isChatOpen=true; }
            if(isChatOpen) { wrapper.style.display='none'; isChatOpen=false; document.getElementById('chat-icon').classList.remove('active'); }
            else { wrapper.style.display='block'; isChatOpen=true; document.getElementById('chat-icon').classList.add('active'); }
        }

        // --- CHAT RENDERING ---
        // --- CHAT SYSTEM ---
        const chatBox = document.getElementById('chat-history');
        const input = document.getElementById('msgInput');
        const focusLockCheck = document.getElementById('focus-lock-check');
        const scrollNotice = document.getElementById('scroll-notice');

        input.addEventListener('blur', () => { if(focusLockCheck.checked && room.style.display!=='none') setTimeout(()=>input.focus(), 10); });

        // RECEIVE CHAT FROM SERVER
        socket.on('chat message', (data) => {
            renderChatLine('chat', data.username, data.message);
            trackMessage(data.username === currentUser);
@@ -242,13 +282,13 @@
        socket.on('system message', (msg) => { renderChatLine('system', null, msg); });

        function renderChatLine(type, username, text) {
            const tolerance = 20;
            const tolerance = 30;
            const isUserAtBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < tolerance;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-line';
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">*** ${text} ***</span>`;
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">‚òÖ ${text}</span>`;
            else {
                msgDiv.innerHTML = `<span class="username">${username}:</span> <span class="message-text">${text}</span>`;
                msgDiv.innerHTML = `<span class="username">${username}</span> <span class="message-text">${text}</span>`;
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv); 
@@ -259,14 +299,13 @@
        function sendMsg() {
            const val = input.value;
            if(val) {
                // Send to server (server will echo it back to everyone)
                socket.emit('chat message', { username: currentUser, message: val });
                input.value = '';
            }
        }
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

        // --- HUD STATS ---
        // --- STATISTICS ---
        let myTotal = 0; let globalTotal = 0; let myPacketsThisSec = 0;
        function trackMessage(isMe) {
            globalTotal++;
@@ -279,51 +318,89 @@
        }
        function resetBattleScores() { myTotal=0; globalTotal=0; document.getElementById('my-score').innerText="0"; document.getElementById('global-score').innerText="0"; }

        // --- 3D SCENE ---
        // =========================================================
        //                 3D SCENE & RENDERING UPGRADES
        // =========================================================
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); 
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 20); 
        
        // 1. Setup Scene with Fog for depth
        const scene = new THREE.Scene(); 
        scene.background = new THREE.Color(0x101020); 
        scene.fog = new THREE.Fog(0x101020, 10, 50);

        // 2. Camera
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 8, 15); 

        // 3. Renderer with Shadows
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = true; // Enable shadows
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.6); dirLight.position.set(10, 20, 15); scene.add(dirLight);

        // ROOM & FURNITURE
        const texLoader = new THREE.TextureLoader();
        const woodTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/hardwood2_diffuse.jpg');
        woodTex.wrapS=woodTex.wrapT=THREE.RepeatWrapping; woodTex.repeat.set(4,4);
        const wallTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg');
        wallTex.wrapS=wallTex.wrapT=THREE.RepeatWrapping; wallTex.repeat.set(2,1);
        
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshStandardMaterial({ map: woodTex }));
        floor.rotation.x = -Math.PI/2; scene.add(floor);
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 12), new THREE.MeshStandardMaterial({ map: wallTex }));
        backWall.position.set(0, 6, -10); scene.add(backWall);

        // COUCH
        // 4. Lighting Upgrades
        // Hemi light (Sky color vs Ground color)
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        // Directional Light (The "Sun") - casting shadows
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 20;
        dirLight.shadow.camera.bottom = -20;
        dirLight.shadow.camera.left = -20;
        dirLight.shadow.camera.right = 20;
        dirLight.shadow.mapSize.width = 2048; // High res shadows
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // 5. Environment (Floor & Grid)
        // Grid Helper
        const grid = new THREE.GridHelper(100, 100, 0x00e5ff, 0x222222);
        grid.position.y = 0.01;
        grid.material.opacity = 0.2;
        grid.material.transparent = true;
        scene.add(grid);

        // Floor Plane
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true; // Floor receives shadows
        scene.add(floor);

        // Furniture (Simple Couch)
        const couchGroup = new THREE.Group();
        const couchMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1.5, 3), couchMat); seat.position.y = 0.75; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2.5, 0.5), couchMat); back.position.y = 2; back.position.z = -1.25; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 3), couchMat); armL.position.set(-4.5, 1, 0); couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 3), couchMat); armR.position.set(4.5, 1, 0); couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); scene.add(couchGroup);
        const couchMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 3), couchMat); seat.position.y = 0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.5), couchMat); back.position.y = 1.5; back.position.z = -1.25; back.castShadow=true; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armL.position.set(-4.5, 0.75, 0); armL.castShadow=true; couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armR.position.set(4.5, 0.75, 0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); 
        scene.add(couchGroup);

        // --- AVATAR SYSTEM ---
        const avatars = {}; // Stores { socketId: { mesh, mixer, actions, target } }
        const loader = new THREE.GLTFLoader();

        // 1. RECEIVE PLAYERS LIST (Includes self + others)
        // 1. RECEIVE ALL PLAYERS (Triggered when we join)
        socket.on('init players', (serverPlayers) => {
            for(let id in serverPlayers) spawnAvatar(serverPlayers[id]);
            // serverPlayers is an object: { socketId: {x, z, username}, ... }
            for(let id in serverPlayers) {
                spawnAvatar(id, serverPlayers[id]);
            }
        });

        // 2. RECEIVE NEW PLAYER
        socket.on('new player', (p) => spawnAvatar(p));
        // 2. RECEIVE NEW PLAYER (Triggered when someone else joins)
        socket.on('new player', (p) => {
            // p contains { id, x, z, username }
            spawnAvatar(p.id, p);
        });

        // 3. REMOVE PLAYER
        socket.on('remove player', (id) => {
@@ -353,15 +430,23 @@
             }
        });

        function spawnAvatar(data) {
            if(avatars[data.id]) return; // prevent duplicates
        function spawnAvatar(id, data) {
            if(avatars[id]) return; // Prevent duplicates

            loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = gltf.scene;
                model.scale.set(0.5,0.5,0.5);
                model.scale.set(0.4, 0.4, 0.4);
                model.position.set(data.x, 0, data.z);
                model.userData = { username: data.username };
                
                // Enable Shadows on Robot
                model.traverse((o) => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });

                // Store username in userData for clicking
                model.userData = { username: data.username, socketId: id };

                scene.add(model);

                // Animations
                const mixer = new THREE.AnimationMixer(model);
                const actions = {};
                const idle = THREE.AnimationClip.findByName(gltf.animations, 'Idle');
@@ -371,41 +456,52 @@

                if(actions['Idle']) actions['Idle'].play();

                avatars[data.id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                avatars[id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                
                // If this is ME, show a welcome message locally
                if(id === mySocketId) {
                    renderChatLine('system', null, "You have entered the room.");
                } else {
                    renderChatLine('system', null, `${data.username} has joined.`);
                }
            });
        }

        function createChatBubble(username, text) {
            // Find the avatar mesh for this username
            let senderMesh = null;
            for(let id in avatars) {
                if(avatars[id].mesh.userData.username === username) senderMesh = avatars[id].mesh;
            }
            if(!senderMesh) return;

            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.2, 0));
            // Project 3D position to 2D screen
            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.0, 0));
            headPos.project(camera);
            
            const x = (headPos.x * .5 + .5) * window.innerWidth;
            const y = (-(headPos.y * .5) + .5) * window.innerHeight;

            const b = document.createElement('div');
            b.className = 'chat-bubble'; b.innerText = text;
            b.style.left = x+'px'; b.style.top = y+'px';
            document.getElementById('room-view').appendChild(b);
            setTimeout(()=>b.remove(), 1500);
            room.appendChild(b);
            
            setTimeout(()=> { b.style.opacity='0'; setTimeout(()=>b.remove(), 500); }, 3000);
        }

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // NODES
        // Navigation Nodes (Invisible Click Targets for movement)
        const nodes = [];
        function createNode(x, z) {
            const geo = new THREE.CylinderGeometry(1, 1, 0.1, 16);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffff00, opacity: 0.3, transparent: true });
            const geo = new THREE.CylinderGeometry(1, 1, 0.1, 8);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00e5ff, opacity: 0.1, transparent: true });
            const node = new THREE.Mesh(geo, mat);
            node.position.set(x, 0.1, z);
            node.userData = { x, z };
            node.position.set(x, 0.05, z);
            node.userData = { type:'node', x, z };
            scene.add(node);
            nodes.push(node);
        }
@@ -418,21 +514,30 @@
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // Check Node Clicks (Movement)
            // 1. Check Movement Nodes
            const nodeHits = raycaster.intersectObjects(nodes);
            if(nodeHits.length > 0) {
                const d = nodeHits[0].object.userData;
                socket.emit('move', { x: d.x, z: d.z });
                closeAvatarMenu();
                return;
            }

            // Check Avatar Clicks (Menu)
            // 2. Check Avatar Clicks (Menu)
            const avatarMeshes = [];
            for(let id in avatars) avatarMeshes.push(avatars[id].mesh);

            let hitAvatar = null;
            for(let av of avatarMeshes) {
                if(raycaster.intersectObject(av, true).length > 0) { hitAvatar = av; break; }
            // Recursively check because GLTF is a group
            const intersects = raycaster.intersectObjects(avatarMeshes, true);
            if(intersects.length > 0) {
                // Traverse up to find the root mesh with user data
                let obj = intersects[0].object;
                while(obj.parent && obj.parent !== scene) {
                    if(obj.userData && obj.userData.username) { hitAvatar = obj; break; }
                    obj = obj.parent;
                }
                if(!hitAvatar && obj.userData.username) hitAvatar = obj;
            }

            if(hitAvatar) {
@@ -441,39 +546,51 @@
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
            } else {
                document.getElementById('avatar-menu').style.display = 'none';
                closeAvatarMenu();
            }
        });

        function closeAvatarMenu() { document.getElementById('avatar-menu').style.display = 'none'; }
        function onWindowResize() {
            camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth,window.innerHeight);
        }
        window.onresize = onWindowResize;

        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.target.set(0,2,0);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; // Don't go below ground

        function animate() {
            requestAnimationFrame(animate);
            if(room.style.display!=='none') {
                const delta = clock.getDelta();
                
                // Update Avatars
                for(let id in avatars) {
                    const av = avatars[id];
                    if(av.mixer) av.mixer.update(delta);
                    
                    // Smooth lerp movement
                    if(av.mesh.position.distanceTo(av.target) > 0.1) {
                        av.mesh.position.lerp(av.target, 0.05);
                    } else if(av.action === 'Walking') {
                        socket.emit('stop move');
                        // Reached destination
                        if(id === mySocketId) socket.emit('stop move'); // Only send stop if it's ME
                        if(av.actions['Walking']) av.actions['Walking'].fadeOut(0.2);
                        if(av.actions['Idle']) av.actions['Idle'].reset().fadeIn(0.2).play();
                        av.action = 'Idle';
                    }
                }

                controls.update();
                renderer.render(scene, camera);
            }
        }
        animate();
        window.onresize = () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); };
    </script>
</body>
</html>
</html>
