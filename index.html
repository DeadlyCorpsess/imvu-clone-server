<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Fixed Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* GLOBAL RESET */
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Verdana', sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; }
        a { text-decoration: none; color: #ffd700; }

        /* --- UI VIEWS --- */
        #signup-view, #dashboard-view, #room-list-view, #room-view, #room-card-overlay { display: none; }
        #login-view { display: flex; }

        /* --- AUTH --- */
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 300px; padding: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid #444; border-radius: 8px; text-align: center; }
        .auth-input { width: 90%; padding: 10px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; font-size: 14px; }
        .auth-btn { width: 100%; padding: 10px; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: none; font-weight: bold; color: black; border-radius: 4px; font-size: 16px; }
        .link-text { margin-top: 20px; font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 12px; margin-bottom: 10px; display: none; }

        /* --- DASHBOARD --- */
        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 50; }
        .imvu-navbar { width: 100%; height: 50px; background: #000; border-bottom: 3px solid #ffd700; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; }
        .nav-logo { font-size: 24px; font-weight: bold; color: white; margin-right: 30px; }
        .nav-item { color: #ccc; margin-right: 20px; font-size: 14px; cursor: pointer; }
        .nav-item:hover { color: #ffd700; }
        .dash-content { display: flex; justify-content: center; align-items: center; height: calc(100% - 50px); background: url('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg') center/cover; }
        .big-btn { width: 200px; height: 150px; background: linear-gradient(to bottom, #444, #222); border: 2px solid #555; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s; }
        .big-btn:hover { transform: scale(1.05); border-color: #ffd700; }
        .big-icon { font-size: 40px; margin-bottom: 10px; }
        .big-text { color: white; font-weight: bold; font-size: 16px; }

        /* --- ROOM BROWSER --- */
        #room-list-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #333; z-index: 60; display: none; flex-direction: column; }
        .browser-header { height: 40px; background: linear-gradient(to bottom, #555, #333); border-bottom: 1px solid #000; display: flex; align-items: flex-end; padding-left: 10px; }
        .browser-tab { padding: 8px 20px; background: #ffd700; color: black; font-weight: bold; font-size: 12px; border-radius: 5px 5px 0 0; margin-right: 5px; cursor: pointer; }
        .browser-body { flex-grow: 1; display: flex; background: #222; }
        .sidebar { width: 220px; background: #1a1a1a; border-right: 1px solid #000; padding: 10px; box-sizing: border-box; }
        .sidebar-title { color: #ffd700; font-size: 12px; font-weight: bold; margin-bottom: 5px; margin-top: 15px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .filter-select { width: 100%; background: #333; color: white; border: 1px solid #555; padding: 4px; font-size: 11px; margin-bottom: 5px; }
        .rooms-grid { flex-grow: 1; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
        
        .room-listing { width: 350px; height: 120px; background: #111; border: 1px solid #444; display: flex; position: relative; cursor: pointer; transition: 0.2s; }
        .room-listing:hover { border-color: #ffd700; }
        .listing-thumb { width: 140px; height: 100%; background: #000; overflow: hidden; }
        .listing-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .listing-info { padding: 8px; }
        .listing-name { font-size: 13px; font-weight: bold; color: #ddd; }
        .listing-author { font-size: 10px; color: #888; }

        /* --- POPUP ROOM CARD --- */
        #room-card-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); z-index: 500;
            display: none; align-items: center; justify-content: center;
        }
        .imvu-room-card {
            width: 600px; background: #f0f0f0; border: 1px solid #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); color: #000;
            font-family: 'Verdana', sans-serif; font-size: 11px;
            display: flex; flex-direction: column;
        }
        .card-header { background: linear-gradient(to bottom, #444, #222); padding: 5px; color: white; display: flex; }
        .card-thumb { width: 180px; height: 110px; background: #000; border: 1px solid #666; margin-right: 10px; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .card-details { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 14px; color: #fff; margin-bottom: 5px; }
        .card-rating { margin-top: 10px; color: #ffd700; font-size: 16px; cursor: default; } /* Read only */
        .close-card { margin-left: auto; cursor: pointer; font-weight: bold; font-size: 14px; color: #aaa; }
        
        .card-body { padding: 10px; background: #f9f9f9; }
        .section-label { background: #eee; color: #88aadd; font-weight: bold; padding: 2px 5px; margin-bottom: 5px; width: fit-content; }
        .description-box { margin-bottom: 10px; color: #333; height: 40px; overflow-y: auto; font-size: 10px; }
        
        .occupants-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; }
        .occupants-table th { background: #fff; text-align: left; padding: 4px; border-bottom: 1px solid #ccc; color: #999; font-weight: normal; font-size: 10px; }
        .occupants-table td { padding: 4px; font-size: 11px; color: #333; }
        .occupants-table tr:nth-child(even) { background: #f0f0f0; }
        
        .card-footer { background: #eee; padding: 8px; border-top: 1px solid #ccc; display: flex; align-items: center; justify-content: space-between; }
        .go-btn-large { background: linear-gradient(to bottom, #ffd700, #ffb300); border: 1px solid #886600; color: black; font-weight: bold; padding: 5px 30px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .go-btn-large:hover { background: #ffeb3b; }

        /* --- 3D ROOM UI --- */
        #room-view { position: relative; width: 100%; height: 100%; overflow: hidden; }
        #canvas-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; background:#000; }
        
        #scene-header { position: absolute; top: 10px; left: 10px; z-index: 150; display: flex; gap: 5px; }
        #scene-rating-box { background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #555; color: white; font-size: 10px; display: flex; align-items: center; }
        .mini-stars { color: #555; cursor: pointer; margin-left: 5px; font-size: 14px; }
        .mini-stars.active { color: #ffd700; }
        
        #info-btn { width: 26px; height: 26px; background: linear-gradient(to bottom, #fff, #ccc); border: 1px solid #999; border-radius: 50%; color: black; font-weight: bold; font-family: serif; font-size: 14px; font-style: italic; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #info-btn:hover { background: #fff; }

        /* --- CHATBOX CSS (FIXED) --- */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 200; /* High Z-Index to show above canvas */
            pointer-events: none; /* Let clicks pass through to 3D scene */
            display: flex; flex-direction: column; justify-content: flex-end; /* Align chat to bottom */
        }
        
        #imvu-chat-panel { 
            pointer-events: auto; /* Enable clicks on the chat itself */
            width: 100%; 
            background-color: rgba(0, 0, 0, 0.85); 
            display: flex; flex-direction: column; 
            border-top: 2px solid #333; 
            height: 150px; 
            transition: height 0.3s; 
            flex-shrink: 0; /* Prevent collapsing */
        }
        
        #chat-interface-wrapper { display: flex; flex-direction: column; flex-grow: 1; padding: 5px; overflow: hidden; }
        #chat-history { flex-grow: 1; overflow-y: scroll; padding: 5px; font-size: 12px; line-height: 1.4; color: white; scrollbar-width: thin; scrollbar-color: #444 #111; }
        .chat-line { margin-bottom: 2px; font-family: 'Verdana', sans-serif; display: block; }
        .username { color: #8FBC8F; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .message-text { color: #e0e0e0; }
        .system-msg { color: #ffd700; font-style: italic; font-weight: bold; font-size: 11px; } 
        
        #input-row { display: flex; align-items: center; background: #111; border-top: 1px solid #333; padding: 2px; flex-shrink: 0; }
        #msgInput { flex-grow: 1; background: #222; border: 1px solid #555; color: white; padding: 4px; font-size: 11px; height: 20px; }
        #send-btn { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 1px solid #c49000; font-weight: bold; font-size: 11px; padding: 3px 10px; margin-left: 5px; }
        
        #toolbar { height: 25px; background-color: #000; display: flex; align-items: center; padding-left: 10px; border-bottom: 2px solid #b8860b; flex-shrink: 0; }
        .icon { width: 35px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #888; cursor: pointer; user-select: none; }
        .icon.active { background: linear-gradient(to bottom, #ffd700, #ffb300); color: black; }
        
        #exit-btn { pointer-events: auto; position: absolute; top: 15px; right: 15px; background: #d32f2f; color: white; border: 1px solid #fff; padding: 5px 10px; font-weight: bold; font-size: 12px; z-index: 300; }

        /* BUBBLES */
        .chat-bubble { position: absolute; background: white; color: black; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 2px 2px 0px rgba(0,0,0,0.3); border: 1px solid #000; pointer-events: none; white-space: nowrap; z-index: 5; animation: floatUp 2.5s forwards; transform-origin: center bottom; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 0; } 10% { transform: translateY(-10px) scale(1.05); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-80px) scale(0.9); opacity: 0; } }
        
        /* MENU */
        #avatar-menu { display: none; position: absolute; width: 150px; background-color: rgba(0, 0, 0, 0.9); border: 1px solid #555; font-size: 12px; z-index: 150; pointer-events: auto; color: #ddd; }
        .action-item { padding: 5px 10px; cursor: pointer; border-bottom: 1px solid #222; } .action-item:hover { background: #333; }
    </style>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">IMVU Classic Login</div>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Sign In</button>
            <div class="link-text" onclick="showSignup()">Sign Up</div>
        </div>
    </div>

    <!-- SIGNUP -->
    <div id="signup-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">Create Account</div>
            <div id="signup-error" class="error-msg">Username taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="New Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="New Password">
            <button class="auth-btn" onclick="handleSignup()">Register</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view">
        <div class="imvu-navbar">
            <div class="nav-logo">IMVU</div>
            <div class="nav-item">Home</div>
            <div class="nav-item">Shop</div>
        </div>
        <div class="dash-content">
            <div class="big-btn" onclick="openRoomBrowser()">
                <div class="big-icon">üí¨</div>
                <div class="big-text">Chat Rooms</div>
            </div>
        </div>
    </div>

    <!-- ROOM BROWSER -->
    <div id="room-list-view">
        <div class="browser-header">
            <div class="browser-tab">Search</div>
            <div class="browser-tab inactive">Manage</div>
        </div>
        <div class="browser-body">
            <div class="sidebar">
                <div class="sidebar-title">Room Type</div>
                <select class="filter-select"><option>All</option></select>
            </div>
            <div class="rooms-grid">
                <div class="room-listing" onclick="openRoomCard(false)">
                    <div class="listing-thumb">
                        <img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" alt="Room">
                    </div>
                    <div class="listing-info">
                        <div class="listing-name">Robot Lounge</div>
                        <div class="listing-author">by Admin</div>
                        <div style="color:#ffd700; font-size:10px;" id="listing-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROOM CARD POPUP -->
    <div id="room-card-overlay">
        <div class="imvu-room-card">
            <div class="card-header">
                <div class="card-thumb"><img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg"></div>
                <div class="card-details">
                    <div class="card-title">Robot Lounge ... *Chill*</div>
                    <div style="color:#ffd700;">by Admin</div>
                    <div style="margin-top:2px;">Language: English</div>
                    <!-- Rating is READ ONLY here -->
                    <div class="card-rating">
                        Room Rating: <span id="card-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span> <span style="font-size:10px; color:#fff;" id="rating-text">(0/5)</span>
                    </div>
                </div>
                <div class="close-card" onclick="closeRoomCard()">‚úñ</div>
            </div>
            <div class="card-body">
                <div class="section-label">room occupants</div>
                <table class="occupants-table">
                    <thead><tr><th>name</th><th>gender</th><th>size</th><th></th></tr></thead>
                    <tbody id="occupant-list"></tbody>
                </table>
            </div>
            <div class="card-footer">
                <button class="go-btn-large" id="card-go-btn" onclick="enterRoom()">Go</button>
            </div>
        </div>
    </div>

    <!-- 3D GAME ROOM -->
    <div id="room-view">
        <div id="scene-header">
            <!-- Rating IS CLICKABLE here -->
            <div id="scene-rating-box">Rate: <span id="scene-stars" class="mini-stars" onclick="rateRoom(event)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
            <div id="info-btn" onclick="openRoomCard(true)">i</div>
        </div>

        <div id="canvas-container"></div>
        <div id="avatar-menu">
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Whisper</div>
        </div>
        
        <button id="exit-btn" onclick="exitRoom()">‚úñ EXIT ROOM</button>
        
        <!-- FIXED CHATBOX -->
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div id="toolbar">
                    <div class="icon active" id="chat-icon" onclick="toggleChatWindow()">üí¨</div>
                </div>
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="input-row">
                        <input type="text" id="msgInput" placeholder="Chat here..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SOCKET SETUP ---
        const socket = io();
        let currentUser = "Guest";
        let mySocketId = null;
        let roomPlayers = {}; 
        let isInRoom = false; 
        let currentRating = parseInt(localStorage.getItem('room_rating')) || 0;

        socket.on('connect', () => { mySocketId = socket.id; });

        // --- AUTH ---
        function getLocalUsers() { return JSON.parse(localStorage.getItem('imvu_users') || '{}'); }
        function showSignup() { document.getElementById('login-view').style.display='none'; document.getElementById('signup-view').style.display='flex'; }
        function showLogin() { document.getElementById('signup-view').style.display='none'; document.getElementById('login-view').style.display='flex'; }
        
        async function handleSignup() {
            const u = document.getElementById('signup-user').value.trim();
            const p = document.getElementById('signup-pass').value.trim();
            if(!u || !p) return;
            const users = getLocalUsers();
            if(users[u]) { document.getElementById('signup-error').style.display='block'; return; }
            users[u] = p;
            localStorage.setItem('imvu_users', JSON.stringify(users));
            alert("Registered! Please login."); showLogin();
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const users = getLocalUsers();
            if(users[u] && users[u] === p) {
                currentUser = u;
                document.getElementById('login-view').style.display='none'; 
                document.getElementById('dashboard-view').style.display='block';
            } else { document.getElementById('login-error').style.display='block'; }
        }

        // --- NAVIGATION ---
        function openRoomBrowser() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('room-list-view').style.display = 'flex';
            updateStarsDisplay(currentRating);
        }

        function openRoomCard(fromInsideRoom) {
            const tbody = document.getElementById('occupant-list');
            tbody.innerHTML = "";

            if (!isInRoom) {
                tbody.innerHTML = `
                    <tr style="background:#ffffcc;">
                        <td><span style="font-size:12px;">üá∫üá∏</span> <u>${currentUser}</u></td>
                        <td>hidden</td>
                        <td>4,200 kb</td>
                        <td><span style="color:#888; font-size:9px;">(You)</span></td>
                    </tr>
                `;
                document.getElementById('card-go-btn').style.display = 'block'; 
            } else {
                document.getElementById('card-go-btn').style.display = 'none'; 
                tbody.innerHTML += `
                    <tr style="background:#ffffcc;">
                        <td><span style="font-size:12px;">üá∫üá∏</span> <u>${currentUser}</u></td>
                        <td>hidden</td>
                        <td>4,200 kb</td>
                        <td><span style="color:#888; font-size:9px;">(You)</span></td>
                    </tr>
                `;
                for (let id in roomPlayers) {
                    if (id === mySocketId) continue; 
                    let p = roomPlayers[id];
                    tbody.innerHTML += `
                        <tr>
                            <td><span style="font-size:12px;">üè≥Ô∏è</span> <u>${p.username}</u></td>
                            <td>?</td>
                            <td>${Math.floor(Math.random() * 5000)} kb</td>
                            <td><a href="#" style="color:#888; font-size:9px;">+ add</a></td>
                        </tr>
                    `;
                }
            }
            updateStarsDisplay(currentRating);
            document.getElementById('room-card-overlay').style.display = 'flex';
        }

        function closeRoomCard() { document.getElementById('room-card-overlay').style.display = 'none'; }

        function rateRoom(e) {
            e.stopPropagation(); 
            // Only update rating if clicked inside the room
            if(currentRating < 5) currentRating++; else currentRating = 0;
            localStorage.setItem('room_rating', currentRating);
            updateStarsDisplay(currentRating);
        }

        function updateStarsDisplay(rating) {
            const stars = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".substring(0, rating) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".substring(0, 5 - rating);
            // Updates card (read-only)
            document.getElementById('card-stars').innerText = stars;
            document.getElementById('rating-text').innerText = `(${rating}/5)`;
            // Updates scene
            document.getElementById('scene-stars').innerText = stars;
            document.getElementById('scene-stars').className = rating > 0 ? "mini-stars active" : "mini-stars";
            // Updates listing
            document.getElementById('listing-stars').innerText = stars;
        }

        function enterRoom() {
            closeRoomCard();
            isInRoom = true;
            document.getElementById('room-list-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            onWindowResize();
            socket.emit('join game', currentUser);
        }

        function exitRoom() { 
            document.getElementById('room-view').style.display = 'none';
            document.getElementById('room-list-view').style.display = 'flex';
            isInRoom = false;
        }

        // --- CHAT LOGIC ---
        const chatBox = document.getElementById('chat-history');
        const input = document.getElementById('msgInput');
        let isChatOpen = true;

        function toggleChatWindow() {
            const wrapper = document.getElementById('chat-interface-wrapper');
            const panel = document.getElementById('imvu-chat-panel');
            if(isChatOpen) { 
                wrapper.style.display='none'; 
                panel.style.height='30px'; 
                isChatOpen=false; 
                document.getElementById('chat-icon').classList.remove('active'); 
            } else { 
                wrapper.style.display='flex'; 
                panel.style.height='150px'; 
                isChatOpen=true; 
                document.getElementById('chat-icon').classList.add('active'); 
            }
        }

        socket.on('chat message', (data) => { renderChatLine('chat', data.username, data.message); });
        socket.on('system message', (msg) => { renderChatLine('system', null, msg); });

        function renderChatLine(type, username, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-line';
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">*** ${text} ***</span>`;
            else {
                msgDiv.innerHTML = `<span class="username">${username}:</span> <span class="message-text">${text}</span>`;
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv); 
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function sendMsg() { if(input.value) { socket.emit('chat message', { username: currentUser, message: input.value }); input.value = ''; } }
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

        // --- 3D SCENE ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.Fog(0x000000, 10, 50);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100); camera.position.set(0, 8, 15); 
        const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.outputEncoding = THREE.sRGBEncoding; renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        container.appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); hemiLight.position.set(0, 20, 0); scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(10, 20, 10); dirLight.castShadow = true;
        dirLight.shadow.camera.top = 20; dirLight.shadow.camera.bottom = -20; dirLight.shadow.camera.left = -20; dirLight.shadow.camera.right = 20; dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        const texLoader = new THREE.TextureLoader();
        const leatherTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/disturb.jpg'); leatherTex.wrapS = leatherTex.wrapT = THREE.RepeatWrapping; leatherTex.repeat.set(2, 2);

        const grid = new THREE.GridHelper(100, 100, 0xffff00, 0x222222); grid.position.y = 0.01; grid.material.opacity = 0.2; grid.material.transparent = true; scene.add(grid);
        const floorGeo = new THREE.PlaneGeometry(100, 100); const floorMat = new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.8 }); const floor = new THREE.Mesh(floorGeo, floorMat); floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

        const couchGroup = new THREE.Group();
        const couchMat = new THREE.MeshStandardMaterial({ map: leatherTex, color: 0x8B4513, roughness: 0.6 });
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 3), couchMat); seat.position.y = 0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.5), couchMat); back.position.y = 1.5; back.position.z = -1.25; back.castShadow=true; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armL.position.set(-4.5, 0.75, 0); armL.castShadow=true; couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armR.position.set(4.5, 0.75, 0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); scene.add(couchGroup);

        const avatars = {}; const loader = new THREE.GLTFLoader();

        socket.on('init players', (serverPlayers) => { 
            roomPlayers = serverPlayers;
            for(let id in serverPlayers) { spawnAvatar(id, serverPlayers[id]); } 
            if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) { openRoomCard(true); }
        });
        
        socket.on('new player', (p) => { 
            roomPlayers[p.id] = p; spawnAvatar(p.id, p); 
            if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) { openRoomCard(true); }
        });
        
        socket.on('remove player', (id) => { 
            delete roomPlayers[id]; if(avatars[id]) { scene.remove(avatars[id].mesh); delete avatars[id]; } 
            if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) { openRoomCard(true); }
        });

        socket.on('player moved', (data) => {
            if(avatars[data.id]) {
                const av = avatars[data.id]; av.target.set(data.x, 0, data.z); av.mesh.lookAt(data.x, 0, data.z);
                if(av.action !== 'Walking') {
                    if(av.actions['Idle']) av.actions['Idle'].fadeOut(0.2); if(av.actions['Sitting']) av.actions['Sitting'].fadeOut(0.2);
                    if(av.actions['Walking']) av.actions['Walking'].reset().fadeIn(0.2).play(); av.action = 'Walking';
                }
            }
        });

        function spawnAvatar(id, data) {
            if(avatars[id]) return; 
            loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = gltf.scene; model.scale.set(0.4, 0.4, 0.4); model.position.set(data.x, 0, data.z);
                model.traverse((o) => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
                model.userData = { username: data.username, socketId: id };
                scene.add(model);
                const mixer = new THREE.AnimationMixer(model); const actions = {};
                ['Idle', 'Walking', 'Sitting'].forEach(name => { const clip = THREE.AnimationClip.findByName(gltf.animations, name); if(clip) actions[name] = mixer.clipAction(clip); });
                if(actions['Idle']) actions['Idle'].play();
                avatars[id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                if(id === mySocketId) { renderChatLine('system', null, "You have entered the room."); } else { renderChatLine('system', null, `${data.username} has joined.`); }
            });
        }

        function createChatBubble(username, text) {
            let senderMesh = null; for(let id in avatars) { if(avatars[id].mesh.userData.username === username) senderMesh = avatars[id].mesh; }
            if(!senderMesh) return;
            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.0, 0)); headPos.project(camera);
            const x = (headPos.x * .5 + .5) * window.innerWidth; const y = (-(headPos.y * .5) + .5) * window.innerHeight;
            const b = document.createElement('div'); b.className = 'chat-bubble'; b.innerText = text; b.style.left = x+'px'; b.style.top = y+'px';
            document.getElementById('room-view').appendChild(b); setTimeout(()=> { b.remove() }, 3000); 
        }

        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2(); const nodes = []; const seats = [];
        function createNode(x, z, type='walk', y=0.05) {
            const geo = new THREE.CylinderGeometry(type==='seat'?0.4:1, type==='seat'?0.4:1, 0.1, 16);
            const color = 0xffff00; 
            const mat = new THREE.MeshBasicMaterial({ color: color, opacity: 0.4, transparent: true });
            const node = new THREE.Mesh(geo, mat); node.position.set(x, y, z); node.userData = { type: type, x: x, z: z };
            scene.add(node); nodes.push(node); if(type === 'seat') seats.push(node);
        }
        createNode(-5, 5); createNode(5, 5); createNode(0, 0); createNode(-5, -5); createNode(5, -5); createNode(-2, -5, 'seat', 0.6); createNode(2, -5, 'seat', 0.6);

        renderer.domElement.addEventListener('pointerdown', (e) => {
            if(document.getElementById('room-view').style.display==='none') return;
            if(document.getElementById('room-card-overlay').style.display === 'flex') return;

            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1; mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const nodeHits = raycaster.intersectObjects(nodes);
            if(nodeHits.length > 0) { const d = nodeHits[0].object.userData; socket.emit('move', { x: d.x, z: d.z }); closeAvatarMenu(); return; }
            const avatarMeshes = []; for(let id in avatars) avatarMeshes.push(avatars[id].mesh);
            let hitAvatar = null; const intersects = raycaster.intersectObjects(avatarMeshes, true);
            if(intersects.length > 0) {
                let obj = intersects[0].object; while(obj.parent && obj.parent !== scene) { if(obj.userData && obj.userData.username) { hitAvatar = obj; break; } obj = obj.parent; }
                if(!hitAvatar && obj.userData.username) hitAvatar = obj;
            }
            if(hitAvatar) {
                const menu = document.getElementById('avatar-menu'); 
                menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
            } else { closeAvatarMenu(); }
        });

        function closeAvatarMenu() { document.getElementById('avatar-menu').style.display = 'none'; }
        function onWindowResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
        window.onresize = onWindowResize;

        const clock = new THREE.Clock(); const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05; controls.maxPolarAngle = Math.PI / 2 - 0.1; 

        function animate() {
            requestAnimationFrame(animate);
            if(document.getElementById('room-view').style.display!=='none') {
                const delta = clock.getDelta();
                for(let id in avatars) {
                    const av = avatars[id]; if(av.mixer) av.mixer.update(delta);
                    if(av.mesh.position.distanceTo(av.target) > 0.1) { av.mesh.position.lerp(av.target, 0.05); } 
                    else if(av.action === 'Walking') {
                        if(id === mySocketId) socket.emit('stop move'); 
                        let isSitting = false; for(let seat of seats) { const d = Math.hypot(av.mesh.position.x - seat.position.x, av.mesh.position.z - seat.position.z); if(d < 0.5) isSitting = true; }
                        if(av.actions['Walking']) av.actions['Walking'].fadeOut(0.2);
                        if(isSitting) { if(av.actions['Sitting']) av.actions['Sitting'].reset().fadeIn(0.2).play(); av.action = 'Sitting'; av.mesh.rotation.y = Math.PI; } 
                        else { if(av.actions['Idle']) av.actions['Idle'].reset().fadeIn(0.2).play(); av.action = 'Idle'; }
                    }
                }
                controls.update(); renderer.render(scene, camera);
            }
        }
        animate();
    </script>
</body>
</html>
