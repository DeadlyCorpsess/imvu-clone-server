<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Live Occupants</title>
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* --- GLOBAL & LAYOUT --- */
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; }
        a { text-decoration: none; color: #ffd700; }

        /* --- VIEWS --- */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 10; }
        #login-view { display: flex; z-index: 20; } 

        /* --- AUTH SCREEN --- */
        .auth-container { background: linear-gradient(135deg, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-box { width: 300px; padding: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid #444; border-radius: 8px; text-align: center; }
        .auth-input { width: 90%; padding: 10px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; }
        .auth-btn { width: 100%; padding: 10px; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: none; font-weight: bold; color: black; border-radius: 4px; cursor: pointer; }
        .link-text { margin-top: 20px; font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 12px; margin-bottom: 10px; display: none; }

        /* --- DASHBOARD --- */
        #dashboard-view { background: #222; }
        .imvu-navbar { width: 100%; height: 50px; background: #000; border-bottom: 3px solid #ffd700; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; }
        .nav-logo { font-size: 24px; font-weight: bold; color: white; margin-right: 30px; }
        .nav-item { color: #ccc; margin-right: 20px; font-size: 14px; cursor: pointer; }
        .dash-content { height: calc(100% - 50px); display: flex; justify-content: center; align-items: center; background: url('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg') center/cover; }
        .big-btn { width: 200px; height: 150px; background: linear-gradient(to bottom, #444, #222); border: 2px solid #555; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .big-btn:hover { border-color: #ffd700; transform: scale(1.05); transition: 0.2s; }
        .big-icon { font-size: 40px; margin-bottom: 10px; }

        /* --- ROOM BROWSER --- */
        #room-list-view { background: #333; display: none; flex-direction: column; }
        .browser-header { height: 40px; background: linear-gradient(to bottom, #555, #333); display: flex; align-items: flex-end; padding-left: 10px; border-bottom: 1px solid #000; }
        .browser-tab { padding: 8px 20px; background: #ffd700; color: black; font-weight: bold; font-size: 12px; border-radius: 5px 5px 0 0; margin-right: 5px; }
        .browser-body { flex-grow: 1; display: flex; background: #222; overflow: hidden; }
        .sidebar { width: 220px; background: #1a1a1a; border-right: 1px solid #000; padding: 10px; }
        .rooms-grid { flex-grow: 1; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
        .room-listing { width: 350px; height: 120px; background: #111; border: 1px solid #444; display: flex; cursor: pointer; }
        .room-listing:hover { border-color: #ffd700; }
        .listing-thumb { width: 140px; background: #000; }
        .listing-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .listing-info { padding: 10px; }

        /* --- ROOM CARD POPUP --- */
        #room-card-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; display: none; align-items: center; justify-content: center; }
        .imvu-room-card { width: 600px; background: #f0f0f0; border: 2px solid #000; color: #000; display: flex; flex-direction: column; font-size: 11px; }
        .card-header { background: linear-gradient(to bottom, #444, #222); padding: 5px; color: white; display: flex; }
        .card-thumb { width: 180px; height: 110px; background: #000; margin-right: 10px; border: 1px solid #666; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .card-details { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .card-rating { margin-top: 10px; color: #ffd700; font-size: 16px; cursor: default; } /* Read only here */
        .close-card { margin-left: auto; cursor: pointer; color: #aaa; font-weight: bold; font-size: 14px; }
        .card-body { padding: 10px; background: #f9f9f9; }
        .occupants-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; margin-top: 5px; }
        .occupants-table th { background: #fff; text-align: left; padding: 4px; border-bottom: 1px solid #ccc; color: #999; }
        .occupants-table td { padding: 4px; color: #333; }
        .occupants-table tr:nth-child(even) { background: #f0f0f0; }
        .card-footer { background: #eee; padding: 8px; border-top: 1px solid #ccc; display: flex; justify-content: flex-end; }
        .go-btn-large { background: linear-gradient(to bottom, #ffd700, #ffb300); border: 1px solid #886600; color: black; font-weight: bold; padding: 5px 30px; cursor: pointer; }

        /* --- 3D ROOM VIEW --- */
        #room-view { width: 100%; height: 100%; position: absolute; z-index: 100; display: none; }
        #canvas-container { width: 100%; height: 100%; display: block; }
        
        /* 3D UI OVERLAYS */
        #scene-header { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; z-index: 200; }
        #scene-rating-box { background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #555; color: white; font-size: 10px; display: flex; align-items: center; }
        .mini-stars { color: #555; cursor: pointer; margin-left: 5px; font-size: 14px; }
        .mini-stars.active { color: #ffd700; }
        #info-btn { width: 26px; height: 26px; background: #fff; border-radius: 50%; color: black; font-weight: bold; font-family: serif; display: flex; align-items: center; justify-content: center; cursor: pointer; font-style: italic; }
        
        #exit-btn { position: absolute; top: 10px; right: 10px; background: #d32f2f; color: white; border: 1px solid #fff; padding: 5px 10px; font-weight: bold; font-size: 11px; z-index: 200; }

        #avatar-menu { display: none; position: absolute; width: 150px; background: rgba(0,0,0,0.9); border: 1px solid #555; z-index: 150; font-size: 12px; }
        .action-item { padding: 5px 10px; cursor: pointer; border-bottom: 1px solid #222; } .action-item:hover { background: #333; }

        .chat-bubble { position: absolute; background: rgba(255,255,255,0.95); color: #000; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 2px 2px 0px rgba(0,0,0,0.5); pointer-events: none; white-space: nowrap; z-index: 120; animation: floatUp 2.5s forwards; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0; } 10% { transform: translateY(-10px); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }

        /* --- YELLOW CHATBOX --- */
        #ui-layer { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            pointer-events: none; 
            z-index: 300; 
            display: flex; flex-direction: column; 
        }
        
        #imvu-chat-panel { 
            pointer-events: auto; 
            width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(20,20,5,0.85)); 
            border-top: 1px solid #ffd700; 
            box-shadow: 0 -5px 20px rgba(255, 215, 0, 0.15);
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column; 
            height: 160px;
            transition: height 0.3s;
        }

        #toolbar { 
            height: 35px; 
            background-color: rgba(0,0,0,0.3); 
            display: flex; align-items: center; 
            padding-left: 15px; 
            border-bottom: 1px solid #333;
            flex-shrink: 0; 
        }
        .icon { cursor: pointer; color: #888; font-size: 18px; transition: 0.2s; } 
        .icon:hover { color: white; }
        .icon.active { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
        
        #chat-interface-wrapper { flex-grow: 1; display: flex; flex-direction: column; padding: 10px 20px; overflow: hidden; }
        
        #chat-history { 
            flex-grow: 1; 
            overflow-y: auto; 
            color: #ddd; 
            font-size: 13px; 
            line-height: 1.6;
            margin-bottom: 10px;
            scrollbar-width: thin; 
            scrollbar-color: #ffd700 transparent; 
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-thumb { background-color: #ffd700; border-radius: 3px; }

        .chat-line { margin-bottom: 5px; display: block; animation: smoothSlideIn 0.3s ease-out forwards; }
        @keyframes smoothSlideIn { 0% { opacity: 0; transform: translateX(-15px); } 100% { opacity: 1; transform: translateX(0); } }

        .username { color: #ffd700; font-weight: bold; cursor: pointer; margin-right: 5px; text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .message-text { color: #eee; }
        .system-msg { color: #888; font-style: italic; font-size: 12px; }
        
        #input-row { 
            display: flex; align-items: center; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid #444; 
            border-radius: 30px; 
            padding: 5px 5px 5px 15px; 
            flex-shrink: 0; 
        }
        #msgInput { flex-grow: 1; background: transparent; border: none; color: white; padding: 8px 0; font-size: 13px; }
        #send-btn { 
            background: #ffd700; color: #000; border: none; 
            font-weight: bold; font-size: 12px; 
            padding: 8px 20px; border-radius: 20px; 
            margin-left: 10px; transition: 0.2s; 
        }
        #send-btn:hover { background: #fff; box-shadow: 0 0 10px #fff; }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-view" class="view-section auth-container">
        <div class="auth-box">
            <h2 style="color:#ffd700; margin-bottom:20px;">IMVU Classic Login</h2>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Sign In</button>
            <div class="link-text" onclick="showSignup()">Sign Up</div>
        </div>
    </div>

    <!-- 2. SIGNUP -->
    <div id="signup-view" class="view-section auth-container">
        <div class="auth-box">
            <h2 style="color:#ffd700; margin-bottom:20px;">Create Account</h2>
            <div id="signup-error" class="error-msg">Username taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="New Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="New Password">
            <button class="auth-btn" onclick="handleSignup()">Register</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- 3. DASHBOARD -->
    <div id="dashboard-view" class="view-section">
        <div class="imvu-navbar">
            <div class="nav-logo">IMVU</div>
            <div class="nav-item">Home</div>
            <div class="nav-item">Shop</div>
        </div>
        <div class="dash-content">
            <div class="big-btn" onclick="openRoomBrowser()">
                <div class="big-icon">üí¨</div>
                <div style="color:white; font-weight:bold;">Chat Rooms</div>
            </div>
        </div>
    </div>

    <!-- 4. ROOM BROWSER -->
    <div id="room-list-view" class="view-section">
        <div class="browser-header">
            <div class="browser-tab">Search</div>
        </div>
        <div class="browser-body">
            <div class="sidebar">
                <div style="color:#ffd700; font-weight:bold; margin-bottom:5px;">Room Type</div>
                <select style="width:100%;"><option>All</option></select>
            </div>
            <div class="rooms-grid">
                <div class="room-listing" onclick="openRoomCard(false)">
                    <div class="listing-thumb"><img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" style="width:100%; height:100%; object-fit:cover;"></div>
                    <div class="listing-info">
                        <div style="color:#ddd; font-weight:bold; font-size:13px;">Robot Lounge</div>
                        <div style="color:#888; font-size:10px;">by Admin</div>
                        <div style="color:#ffd700; font-size:10px;" id="listing-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. ROOM CARD POPUP -->
    <div id="room-card-overlay">
        <div class="imvu-room-card">
            <div class="card-header">
                <div class="card-thumb"><img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" style="width:100%; height:100%; object-fit:cover;"></div>
                <div class="card-details">
                    <div class="card-title">Robot Lounge ... *Chill*</div>
                    <div style="color:#ffd700;">by Admin</div>
                    <div style="margin-top:2px;">Language: English</div>
                    <div class="card-rating">
                        Rating: <span id="card-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span> <span style="font-size:10px; color:#fff;" id="rating-text">(0/5)</span>
                    </div>
                </div>
                <div class="close-card" onclick="closeRoomCard()">‚úñ</div>
            </div>
            <div class="card-body">
                <div style="background:#eee; color:#444; font-weight:bold; padding:2px 5px; display:inline-block; margin-bottom:5px;">room occupants</div>
                <table class="occupants-table">
                    <thead><tr><th>name</th><th>gender</th><th>size</th><th></th></tr></thead>
                    <tbody id="occupant-list"></tbody>
                </table>
            </div>
            <div class="card-footer">
                <button id="card-go-btn" class="go-btn-large" onclick="enterRoom()">Go</button>
            </div>
        </div>
    </div>

    <!-- 6. 3D GAME ROOM -->
    <div id="room-view" class="view-section">
        <!-- Overlay UI -->
        <div id="scene-header">
            <div id="scene-rating-box">Rate: <span id="scene-stars" class="mini-stars" onclick="rateRoom(event)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
            <div id="info-btn" onclick="openRoomCard(true)">i</div>
        </div>
        <button id="exit-btn" onclick="exitRoom()">‚úñ EXIT ROOM</button>

        <!-- 3D Canvas -->
        <div id="canvas-container"></div>

        <!-- Avatar Menu -->
        <div id="avatar-menu">
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Whisper</div>
        </div>

        <!-- YELLOW CHATBOX -->
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="input-row">
                        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">SEND</button>
                    </div>
                </div>
                <div id="toolbar">
                    <div class="icon active" id="chat-icon" onclick="toggleChatWindow()">üí¨</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SOCKET SETUP ---
        const socket = io();
        let currentUser = "Guest";
        let mySocketId = null;
        let roomPlayers = {};
        let isInRoom = false;
        let currentRating = parseInt(localStorage.getItem('room_rating')) || 0;

        socket.on('connect', () => { mySocketId = socket.id; });

        // --- AUTH ---
        function getLocalUsers() { return JSON.parse(localStorage.getItem('imvu_users') || '{}'); }
        
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'flex'; 
            if(viewId === 'room-view' || viewId === 'dashboard-view') document.getElementById(viewId).style.display = 'block';
        }

        function showSignup() { switchView('signup-view'); }
        function showLogin() { switchView('login-view'); }

        async function handleSignup() {
            const u = document.getElementById('signup-user').value.trim();
            const p = document.getElementById('signup-pass').value.trim();
            if(!u || !p) return;
            const users = getLocalUsers();
            if(users[u]) { document.getElementById('signup-error').style.display='block'; return; }
            users[u] = p;
            localStorage.setItem('imvu_users', JSON.stringify(users));
            alert("Registered! Please login."); showLogin();
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const users = getLocalUsers();
            if(users[u] && users[u] === p) {
                currentUser = u;
                switchView('dashboard-view');
            } else { document.getElementById('login-error').style.display='block'; }
        }

        // --- ROOM LOGIC ---
        function openRoomBrowser() {
            switchView('room-list-view');
            document.getElementById('room-list-view').style.display = 'flex';
            updateStarsDisplay(currentRating);
        }

        function openRoomCard(fromInsideRoom) {
            const tbody = document.getElementById('occupant-list');
            tbody.innerHTML = "";

            // LOGIC: If not in room, list is EMPTY.
            if (!isInRoom) {
                // Empty list, show Go button
                document.getElementById('card-go-btn').style.display = 'block';
            } else {
                // In room: Show Me + Others
                document.getElementById('card-go-btn').style.display = 'none';
                
                // Add Me
                tbody.innerHTML += `
                    <tr style="background:#ffffcc;">
                        <td><span style="font-size:12px;">üá∫üá∏</span> <u>${currentUser}</u></td>
                        <td>hidden</td>
                        <td>4,200 kb</td>
                        <td><span style="color:#888; font-size:9px;">(You)</span></td>
                    </tr>
                `;
                // Add Others
                for (let id in roomPlayers) {
                    if (id === mySocketId) continue;
                    let p = roomPlayers[id];
                    tbody.innerHTML += `
                        <tr>
                            <td><span style="font-size:12px;">üè≥Ô∏è</span> <u>${p.username}</u></td>
                            <td>?</td>
                            <td>${Math.floor(Math.random() * 5000)} kb</td>
                            <td><a href="#" style="color:#888; font-size:9px;">+ add</a></td>
                        </tr>
                    `;
                }
            }
            updateStarsDisplay(currentRating);
            document.getElementById('room-card-overlay').style.display = 'flex';
        }

        function closeRoomCard() { document.getElementById('room-card-overlay').style.display = 'none'; }

        function rateRoom(e) {
            e.stopPropagation();
            if(currentRating < 5) currentRating++; else currentRating = 0;
            localStorage.setItem('room_rating', currentRating);
            updateStarsDisplay(currentRating);
        }

        function updateStarsDisplay(rating) {
            const stars = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".substring(0, rating) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".substring(0, 5 - rating);
            document.getElementById('card-stars').innerText = stars;
            document.getElementById('rating-text').innerText = `(${rating}/5)`;
            document.getElementById('scene-stars').innerText = stars;
            document.getElementById('scene-stars').className = rating > 0 ? "mini-stars active" : "mini-stars";
            document.getElementById('listing-stars').innerText = stars;
        }

        function enterRoom() {
            closeRoomCard();
            isInRoom = true;
            switchView('room-view');
            onWindowResize(); 
            socket.emit('join game', currentUser);
        }

        function exitRoom() {
            isInRoom = false;
            switchView('room-list-view');
            document.getElementById('room-list-view').style.display = 'flex';
        }

        // --- CHAT LOGIC ---
        let isChatOpen = true;
        function toggleChatWindow() {
            const wrapper = document.getElementById('chat-interface-wrapper');
            const panel = document.getElementById('imvu-chat-panel');
            if(isChatOpen) { 
                wrapper.style.display='none'; 
                panel.style.height='40px'; 
                isChatOpen=false; 
                document.getElementById('chat-icon').classList.remove('active'); 
            } else { 
                wrapper.style.display='flex'; 
                panel.style.height='160px'; 
                isChatOpen=true; 
                document.getElementById('chat-icon').classList.add('active'); 
            }
        }

        const chatBox = document.getElementById('chat-history');
        const input = document.getElementById('msgInput');
        socket.on('chat message', (data) => { renderChatLine('chat', data.username, data.message); });
        socket.on('system message', (msg) => { renderChatLine('system', null, msg); });

        function renderChatLine(type, username, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-line';
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">‚òÖ ${text}</span>`;
            else {
                msgDiv.innerHTML = `<span class="username">${username}</span> <span class="message-text">${text}</span>`;
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv); chatBox.scrollTop = chatBox.scrollHeight;
        }
        function sendMsg() { if(input.value) { socket.emit('chat message', { username: currentUser, message: input.value }); input.value = ''; } }
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

        // --- 3D SCENE & SOCKET UPDATES ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.Fog(0x000000, 10, 50);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100); camera.position.set(0, 8, 15);
        const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.outputEncoding = THREE.sRGBEncoding; renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        container.appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); hemiLight.position.set(0, 20, 0); scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(10, 20, 10); dirLight.castShadow = true;
        dirLight.shadow.camera.top = 20; dirLight.shadow.camera.bottom = -20; dirLight.shadow.camera.left = -20; dirLight.shadow.camera.right = 20; dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048; scene.add(dirLight);

        const texLoader = new THREE.TextureLoader();
        const leatherTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/disturb.jpg'); leatherTex.wrapS = leatherTex.wrapT = THREE.RepeatWrapping; leatherTex.repeat.set(2, 2);

        const grid = new THREE.GridHelper(100, 100, 0xffff00, 0x222222); grid.position.y = 0.01; grid.material.opacity = 0.2; grid.material.transparent = true; scene.add(grid);
        const floorGeo = new THREE.PlaneGeometry(100, 100); const floorMat = new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.8 }); const floor = new THREE.Mesh(floorGeo, floorMat); floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

        const couchGroup = new THREE.Group();
        const couchMat = new THREE.MeshStandardMaterial({ map: leatherTex, color: 0x8B4513, roughness: 0.6 });
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 3), couchMat); seat.position.y = 0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.5), couchMat); back.position.y = 1.5; back.position.z = -1.25; back.castShadow=true; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armL.position.set(-4.5, 0.75, 0); armL.castShadow=true; couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armR.position.set(4.5, 0.75, 0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); scene.add(couchGroup);

        const avatars = {}; const loader = new THREE.GLTFLoader();

        socket.on('init players', (serverPlayers) => { roomPlayers = serverPlayers; for(let id in serverPlayers) { spawnAvatar(id, serverPlayers[id]); } if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) openRoomCard(true); });
        socket.on('new player', (p) => { roomPlayers[p.id] = p; spawnAvatar(p.id, p); if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) openRoomCard(true); });
        socket.on('remove player', (id) => { delete roomPlayers[id]; if(avatars[id]) { scene.remove(avatars[id].mesh); delete avatars[id]; } if(document.getElementById('room-card-overlay').style.display === 'flex' && isInRoom) openRoomCard(true); });
        
        socket.on('player moved', (data) => {
            if(avatars[data.id]) {
                const av = avatars[data.id]; av.target.set(data.x, 0, data.z); av.mesh.lookAt(data.x, 0, data.z);
                if(av.action !== 'Walking') {
                    if(av.actions['Idle']) av.actions['Idle'].fadeOut(0.2); if(av.actions['Sitting']) av.actions['Sitting'].fadeOut(0.2);
                    if(av.actions['Walking']) av.actions['Walking'].reset().fadeIn(0.2).play(); av.action = 'Walking';
                }
            }
        });

        function spawnAvatar(id, data) {
            if(avatars[id]) return; 
            loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = gltf.scene; model.scale.set(0.4, 0.4, 0.4); model.position.set(data.x, 0, data.z);
                model.traverse((o) => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
                model.userData = { username: data.username, socketId: id }; scene.add(model);
                const mixer = new THREE.AnimationMixer(model); const actions = {};
                ['Idle', 'Walking', 'Sitting'].forEach(name => { const clip = THREE.AnimationClip.findByName(gltf.animations, name); if(clip) actions[name] = mixer.clipAction(clip); });
                if(actions['Idle']) actions['Idle'].play();
                avatars[id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                if(id === mySocketId) renderChatLine('system', null, "You have entered the room."); else renderChatLine('system', null, `${data.username} has joined.`);
            });
        }

        function createChatBubble(username, text) {
            let senderMesh = null; for(let id in avatars) { if(avatars[id].mesh.userData.username === username) senderMesh = avatars[id].mesh; }
            if(!senderMesh) return;
            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.0, 0)); headPos.project(camera);
            const x = (headPos.x * .5 + .5) * window.innerWidth; const y = (-(headPos.y * .5) + .5) * window.innerHeight;
            const b = document.createElement('div'); b.className = 'chat-bubble'; b.innerText = text; b.style.left = x+'px'; b.style.top = y+'px';
            document.getElementById('room-view').appendChild(b); setTimeout(()=> { b.remove() }, 3000); 
        }

        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2(); const nodes = []; const seats = [];
        function createNode(x, z, type='walk', y=0.05) {
            const geo = new THREE.CylinderGeometry(type==='seat'?0.4:1, type==='seat'?0.4:1, 0.1, 16);
            const color = 0xffff00; 
            const mat = new THREE.MeshBasicMaterial({ color: color, opacity: 0.4, transparent: true });
            const node = new THREE.Mesh(geo, mat); node.position.set(x, y, z); node.userData = { type: type, x: x, z: z };
            scene.add(node); nodes.push(node); if(type === 'seat') seats.push(node);
        }
        createNode(-5, 5); createNode(5, 5); createNode(0, 0); createNode(-5, -5); createNode(5, -5); createNode(-2, -5, 'seat', 0.6); createNode(2, -5, 'seat', 0.6);

        renderer.domElement.addEventListener('pointerdown', (e) => {
            if(document.getElementById('room-view').style.display==='none' || document.getElementById('room-card-overlay').style.display === 'flex') return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1; mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const nodeHits = raycaster.intersectObjects(nodes);
            if(nodeHits.length > 0) { const d = nodeHits[0].object.userData; socket.emit('move', { x: d.x, z: d.z }); closeAvatarMenu(); return; }
            const avatarMeshes = []; for(let id in avatars) avatarMeshes.push(avatars[id].mesh);
            let hitAvatar = null; const intersects = raycaster.intersectObjects(avatarMeshes, true);
            if(intersects.length > 0) {
                let obj = intersects[0].object; while(obj.parent && obj.parent !== scene) { if(obj.userData && obj.userData.username) { hitAvatar = obj; break; } obj = obj.parent; }
                if(!hitAvatar && obj.userData.username) hitAvatar = obj;
            }
            if(hitAvatar) {
                const menu = document.getElementById('avatar-menu'); 
                menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
            } else { closeAvatarMenu(); }
        });

        function closeAvatarMenu() { document.getElementById('avatar-menu').style.display = 'none'; }
        function onWindowResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
        window.onresize = onWindowResize;

        const clock = new THREE.Clock(); const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05; controls.maxPolarAngle = Math.PI / 2 - 0.1; 

        function animate() {
            requestAnimationFrame(animate);
            if(document.getElementById('room-view').style.display!=='none') {
                const delta = clock.getDelta();
                for(let id in avatars) {
                    const av = avatars[id]; if(av.mixer) av.mixer.update(delta);
                    if(av.mesh.position.distanceTo(av.target) > 0.1) { av.mesh.position.lerp(av.target, 0.05); } 
                    else if(av.action === 'Walking') {
                        if(id === mySocketId) socket.emit('stop move'); 
                        let isSitting = false; for(let seat of seats) { const d = Math.hypot(av.mesh.position.x - seat.position.x, av.mesh.position.z - seat.position.z); if(d < 0.5) isSitting = true; }
                        if(av.actions['Walking']) av.actions['Walking'].fadeOut(0.2);
                        if(isSitting) { if(av.actions['Sitting']) av.actions['Sitting'].reset().fadeIn(0.2).play(); av.action = 'Sitting'; av.mesh.rotation.y = Math.PI; } 
                        else { if(av.actions['Idle']) av.actions['Idle'].reset().fadeIn(0.2).play(); av.action = 'Idle'; }
                    }
                }
                controls.update(); renderer.render(scene, camera);
            }
        }
        animate();
    </script>
</body>
</html>
