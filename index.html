<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Room Browser</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* GLOBAL RESET */
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Verdana', sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; }
        a { text-decoration: none; color: #ffd700; }

        /* --- UI VIEWS --- */
        #signup-view, #dashboard-view, #room-list-view, #room-view { display: none; }
        #login-view { display: flex; }

        /* --- AUTH & DASHBOARD --- */
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 300px; padding: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid #444; border-radius: 8px; text-align: center; }
        .auth-input { width: 90%; padding: 10px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; font-size: 14px; }
        .auth-btn { width: 100%; padding: 10px; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: none; font-weight: bold; color: black; border-radius: 4px; font-size: 16px; }
        .link-text { margin-top: 20px; font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 12px; margin-bottom: 10px; display: none; }

        /* --- MAIN DASHBOARD (The "Home" Screen) --- */
        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 50; }
        .imvu-navbar { width: 100%; height: 50px; background: #000; border-bottom: 3px solid #ffd700; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; }
        .nav-logo { font-size: 24px; font-weight: bold; color: white; margin-right: 30px; }
        .nav-item { color: #ccc; margin-right: 20px; font-size: 14px; cursor: pointer; }
        .nav-item:hover { color: #ffd700; }
        
        .dash-content { display: flex; justify-content: center; align-items: center; height: calc(100% - 50px); background: url('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg') center/cover; }
        .big-btn { 
            width: 200px; height: 150px; 
            background: linear-gradient(to bottom, #444, #222); 
            border: 2px solid #555; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: 0.2s;
        }
        .big-btn:hover { transform: scale(1.05); border-color: #ffd700; }
        .big-icon { font-size: 40px; margin-bottom: 10px; }
        .big-text { color: white; font-weight: bold; font-size: 16px; }

        /* --- ROOM BROWSER (IMVU STYLE) --- */
        #room-list-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #333; z-index: 60; display: none; flex-direction: column; }
        
        .browser-header { height: 40px; background: linear-gradient(to bottom, #555, #333); border-bottom: 1px solid #000; display: flex; align-items: flex-end; padding-left: 10px; }
        .browser-tab { padding: 8px 20px; background: #ffd700; color: black; font-weight: bold; font-size: 12px; border-radius: 5px 5px 0 0; margin-right: 5px; cursor: pointer; }
        .browser-tab.inactive { background: #444; color: #aaa; }
        
        .browser-body { flex-grow: 1; display: flex; background: #222; }
        .sidebar { width: 220px; background: #1a1a1a; border-right: 1px solid #000; padding: 10px; box-sizing: border-box; }
        .sidebar-title { color: #ffd700; font-size: 12px; font-weight: bold; margin-bottom: 5px; margin-top: 15px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .filter-select { width: 100%; background: #333; color: white; border: 1px solid #555; padding: 4px; font-size: 11px; margin-bottom: 5px; }
        
        .rooms-grid { flex-grow: 1; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
        
        /* ROOM CARD */
        .room-card { width: 350px; height: 120px; background: #111; border: 1px solid #444; display: flex; position: relative; }
        .room-thumb { width: 140px; height: 100%; background: #000; position: relative; overflow: hidden; }
        .room-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .room-info { flex-grow: 1; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; }
        .room-name { font-size: 13px; font-weight: bold; color: #ddd; margin-bottom: 2px; }
        .room-author { font-size: 10px; color: #888; }
        .room-rating { font-size: 10px; color: #ffd700; margin-top: 2px; }
        .room-stats { font-size: 10px; color: #aaa; margin-top: auto; }
        
        .card-actions { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 5px; }
        .info-btn { background: #333; color: white; border: 1px solid #555; font-size: 10px; padding: 3px 8px; cursor: pointer; }
        .go-btn { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 1px solid #c49000; font-weight: bold; font-size: 11px; padding: 3px 15px; cursor: pointer; }
        .go-btn:hover { filter: brightness(1.1); }

        .ap-badge { position: absolute; top: 0; right: 0; background: #ff0000; color: white; font-size: 9px; padding: 1px 3px; font-weight: bold; }

        /* --- 3D ROOM UI --- */
        #imvu-chat-panel { pointer-events: auto; width: 100%; background-color: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; border-top: 2px solid #333; transition: height 0.3s; }
        #exit-btn { pointer-events: auto; position: absolute; top: 15px; right: 15px; background: #d32f2f; color: white; border: 1px solid #fff; padding: 5px 10px; font-weight: bold; font-size: 12px; z-index: 200; }
        
        #battle-hud { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 450px; background: rgba(0,0,0,0.9); border: 2px solid #ffd700; border-radius: 8px; padding: 15px; z-index: 200; pointer-events: auto; text-align: center; display: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .hud-title { color: #ffd700; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: monospace; font-size: 14px; }
        .score-box { width: 45%; background: #222; padding: 5px; border: 1px solid #444; border-radius: 4px; }
        .score-val { font-size: 24px; font-weight: bold; color: #fff; }
        .mps-val { font-size: 11px; color: #aaa; }
        .control-row { margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; color: #888; font-size: 11px; }

        .chat-bubble { position: absolute; background: white; color: black; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; font-family: 'Verdana', sans-serif; box-shadow: 2px 2px 0px rgba(0,0,0,0.3); border: 1px solid #000; pointer-events: none; white-space: nowrap; z-index: 5; animation: floatUp 2.5s forwards; transform-origin: center bottom; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 0; } 10% { transform: translateY(-10px) scale(1.05); opacity: 1; } 20% { transform: translateY(-10px) scale(1); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-80px) scale(0.9); opacity: 0; } }

        #avatar-menu { display: none; position: absolute; width: 180px; background-color: rgba(0, 0, 0, 0.9); border: 1px solid #555; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.8); font-size: 13px; z-index: 150; pointer-events: auto; color: #ddd; overflow: hidden; }
        .menu-header { background-color: #111; padding: 8px 12px; display: flex; align-items: center; border-bottom: 1px solid #444; font-weight: bold; color: #fff; }
        .close-menu { margin-left: auto; cursor: pointer; color: #888; } .close-menu:hover { color: white; }
        .action-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #222; transition: 0.2s; }
        .action-item:hover { background-color: #333; color: white; }

        #chat-interface-wrapper { display: block; padding: 10px; }
        #chat-history { height: 200px; overflow-y: scroll; padding: 5px; font-size: 13px; line-height: 1.6; color: white; scrollbar-width: thin; scrollbar-color: #444 #111; }
        .chat-line { margin-bottom: 3px; display: block; font-family: 'Verdana', sans-serif; }
        .username { color: #8FBC8F; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .message-text { color: #e0e0e0; }
        .system-msg { color: #ffd700; font-style: italic; font-weight: bold; font-size: 12px; } 
        #input-row { display: flex; align-items: center; background: #111; border-top: 1px solid #333; padding: 5px; }
        #msgInput { flex-grow: 1; background: #222; border: 1px solid #555; color: white; padding: 6px; font-size: 12px; }
        #send-btn { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 1px solid #c49000; font-weight: bold; font-size: 12px; padding: 6px 15px; margin-left: 5px; }
        #toolbar { height: 35px; background-color: #000; display: flex; align-items: center; padding-left: 10px; border-bottom: 2px solid #b8860b; }
        .icon { width: 35px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #888; cursor: pointer; user-select: none; }
        .icon.active { background: linear-gradient(to bottom, #ffd700, #ffb300); color: black; }
        #scroll-notice { position: absolute; bottom: 50px; right: 20px; background: #333; color: yellow; font-size: 10px; padding: 2px 5px; border: 1px solid yellow; display: none; z-index: 500; }
    </style>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">IMVU Classic Login</div>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Sign In</button>
            <div class="link-text" onclick="showSignup()">Sign Up</div>
        </div>
    </div>

    <!-- 2. SIGNUP SCREEN -->
    <div id="signup-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 24px; color: #ffd700; font-weight: bold; margin-bottom: 20px;">Create Account</div>
            <div id="signup-error" class="error-msg">Username taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="New Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="New Password">
            <button class="auth-btn" onclick="handleSignup()">Register</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- 3. DASHBOARD / HOME -->
    <div id="dashboard-view">
        <div class="imvu-navbar">
            <div class="nav-logo">IMVU</div>
            <div class="nav-item">Home</div>
            <div class="nav-item">Shop</div>
            <div class="nav-item">Credits</div>
        </div>
        <div class="dash-content">
            <div class="big-btn" onclick="openRoomBrowser()">
                <div class="big-icon">ðŸ’¬</div>
                <div class="big-text">Chat Rooms</div>
            </div>
        </div>
    </div>

    <!-- 4. ROOM BROWSER (Menu from Screenshot) -->
    <div id="room-list-view">
        <div class="browser-header">
            <div class="browser-tab">Search</div>
            <div class="browser-tab inactive">Manage</div>
        </div>
        <div class="browser-body">
            <!-- Left Filters -->
            <div class="sidebar">
                <div class="sidebar-title">Language</div>
                <select class="filter-select"><option>English</option></select>
                <div class="sidebar-title">Occupancy</div>
                <select class="filter-select"><option>Any</option></select>
                <div class="sidebar-title">Room Type</div>
                <select class="filter-select"><option>All</option></select>
                
                <div class="link-text" style="color:#ffd700; margin-top:20px;">My Favorites</div>
                <div class="link-text" style="color:#aaa;">Recently Visited</div>
            </div>
            
            <!-- Room Grid -->
            <div class="rooms-grid">
                <!-- THE SPECIFIC ROOM CARD -->
                <div class="room-card">
                    <div class="room-thumb">
                        <img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" alt="Room">
                        <div class="ap-badge">AP</div>
                    </div>
                    <div class="room-info">
                        <div>
                            <div class="room-name">Robot Lounge</div>
                            <div class="room-author">by Admin</div>
                            <div class="room-rating">â˜…â˜…â˜…â˜…â˜… 5/5</div>
                        </div>
                        <div class="room-stats">
                            ðŸ‘¤ 1 / 10
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="info-btn">Info</button>
                        <button class="go-btn" onclick="enterRoom()">Go</button>
                    </div>
                </div>
                <!-- Fake filler cards just for looks -->
                <div class="room-card" style="opacity:0.5; pointer-events:none;">
                    <div class="room-thumb" style="background:#222;"></div>
                    <div class="room-info"><div class="room-name">Locked Room</div><div class="room-author">by System</div></div>
                </div>
                <div class="room-card" style="opacity:0.5; pointer-events:none;">
                    <div class="room-thumb" style="background:#222;"></div>
                    <div class="room-info"><div class="room-name">Locked Room</div><div class="room-author">by System</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. 3D GAME ROOM -->
    <div id="room-view">
        <div id="battle-hud">
            <div class="hud-title">Server Stats</div>
            <div class="score-row">
                <div class="score-box" style="border-color: #00ff00;">
                    <div style="color:#00ff00; font-size:11px; font-weight:bold;">YOU</div>
                    <div class="score-val" id="my-score">0</div>
                    <div class="mps-val" id="my-mps">0 MPS</div>
                </div>
                <div class="score-box" style="border-color: #ff5555;">
                    <div style="color:#ff5555; font-size:11px; font-weight:bold;">GLOBAL</div>
                    <div class="score-val" id="global-score">0</div>
                </div>
            </div>
            <div class="control-row">
                <p>Click yellow nodes on the couch to sit.</p>
                <button onclick="resetBattleScores()" style="background:#333; color:#fff; border:1px solid #555; padding:2px 10px; font-size:10px;">RESET</button>
            </div>
        </div>

        <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; background:#000;"></div>
        
        <div id="avatar-menu">
            <div class="menu-header" id="menu-header-handle">
                <span id="menu-username-display">User</span> 
                <span class="close-menu" onclick="closeAvatarMenu()">âœ–</span>
            </div>
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Trade</div>
        </div>

        <button id="exit-btn" onclick="exitRoom()">âœ– EXIT ROOM</button>
        
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div class="chat-header-bar" style="height: 10px; background: #222;"></div>
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="scroll-notice">VIEW PAUSED (Scroll down)</div>
                    <div id="input-row">
                        <label style="margin-right:10px; color:#aaa; font-size:10px;"><input type="checkbox" id="focus-lock-check" checked> Lock Focus</label>
                        <input type="text" id="msgInput" placeholder="Chat here..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">Send</button>
                    </div>
                </div>
                <div id="toolbar">
                    <div class="icon active" id="chat-icon" onclick="toggleChatWindow()">ðŸ’¬</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SOCKET SETUP ---
        const socket = io();
        let currentUser = "Guest";
        let mySocketId = null; 

        socket.on('connect', () => { mySocketId = socket.id; });

        // --- AUTH & NAV ---
        function showSignup() { document.getElementById('login-view').style.display='none'; document.getElementById('signup-view').style.display='flex'; }
        function showLogin() { document.getElementById('signup-view').style.display='none'; document.getElementById('login-view').style.display='flex'; }
        
        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success){ currentUser=data.username; document.getElementById('login-view').style.display='none'; document.getElementById('dashboard-view').style.display='block'; }
            else { showError('login-error', data.msg); }
        }
        async function handleSignup() {
            const u = document.getElementById('signup-user').value;
            const p = document.getElementById('signup-pass').value;
            const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success) { alert("Registered! Please login."); showLogin(); }
            else { showError('signup-error', data.msg); }
        }
        function showError(id, msg) { const el = document.getElementById(id); el.style.display = 'block'; el.innerText = msg; setTimeout(()=>el.style.display='none', 3000); }

        function openRoomBrowser() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('room-list-view').style.display = 'flex';
        }

        // --- ENTER 3D ROOM ---
        function enterRoom() {
            document.getElementById('room-list-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            document.getElementById('battle-hud').style.display = 'block';
            onWindowResize();
            socket.emit('join game', currentUser);
            setInterval(calculateMPS, 1000);
        }
        function exitRoom() { location.reload(); }

        let isChatOpen = true;
        function toggleChatWindow() {
            const wrapper = document.getElementById('chat-interface-wrapper');
            if(isChatOpen) { wrapper.style.display='none'; isChatOpen=false; document.getElementById('chat-icon').classList.remove('active'); }
            else { wrapper.style.display='block'; isChatOpen=true; document.getElementById('chat-icon').classList.add('active'); }
        }

        // --- CHAT LOGIC ---
        const chatBox = document.getElementById('chat-history');
        const input = document.getElementById('msgInput');
        const focusLockCheck = document.getElementById('focus-lock-check');
        const scrollNotice = document.getElementById('scroll-notice');
        
        input.addEventListener('blur', () => { if(focusLockCheck.checked && document.getElementById('room-view').style.display!=='none') setTimeout(()=>input.focus(), 10); });

        socket.on('chat message', (data) => {
            renderChatLine('chat', data.username, data.message);
            trackMessage(data.username === currentUser);
        });

        socket.on('system message', (msg) => { renderChatLine('system', null, msg); });

        function renderChatLine(type, username, text) {
            const tolerance = 20;
            const isUserAtBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < tolerance;
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-line`;
            
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">*** ${text} ***</span>`;
            else {
                msgDiv.innerHTML = `<span class="username">${username}:</span> <span class="message-text">${text}</span>`;
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv); 
            
            if (isUserAtBottom) { chatBox.scrollTop = chatBox.scrollHeight; scrollNotice.style.display = 'none'; }
            else { scrollNotice.style.display = 'block'; }
        }

        function sendMsg() {
            const val = input.value;
            if(val) {
                socket.emit('chat message', { username: currentUser, message: val });
                input.value = '';
            }
        }
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

        // --- STATISTICS ---
        let myTotal = 0; let globalTotal = 0; let myPacketsThisSec = 0;
        function trackMessage(isMe) {
            globalTotal++;
            document.getElementById('global-score').innerText = globalTotal;
            if(isMe) { myTotal++; myPacketsThisSec++; document.getElementById('my-score').innerText = myTotal; }
        }
        function calculateMPS() {
            document.getElementById('my-mps').innerText = myPacketsThisSec + " MPS";
            myPacketsThisSec = 0; 
        }
        function resetBattleScores() { myTotal=0; globalTotal=0; document.getElementById('my-score').innerText="0"; document.getElementById('global-score').innerText="0"; }

        // =========================================================
        //          3D SCENE & TEXTURED COUCH
        // =========================================================
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.Fog(0x000000, 10, 50);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100); camera.position.set(0, 8, 15); 
        const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.outputEncoding = THREE.sRGBEncoding; renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        container.appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); hemiLight.position.set(0, 20, 0); scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(10, 20, 10); dirLight.castShadow = true;
        dirLight.shadow.camera.top = 20; dirLight.shadow.camera.bottom = -20; dirLight.shadow.camera.left = -20; dirLight.shadow.camera.right = 20; dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        const texLoader = new THREE.TextureLoader();
        const leatherTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/disturb.jpg'); leatherTex.wrapS = leatherTex.wrapT = THREE.RepeatWrapping; leatherTex.repeat.set(2, 2);

        const grid = new THREE.GridHelper(100, 100, 0xffff00, 0x222222); grid.position.y = 0.01; grid.material.opacity = 0.2; grid.material.transparent = true; scene.add(grid);
        const floorGeo = new THREE.PlaneGeometry(100, 100); const floorMat = new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.8 }); const floor = new THREE.Mesh(floorGeo, floorMat); floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

        const couchGroup = new THREE.Group();
        const couchMat = new THREE.MeshStandardMaterial({ map: leatherTex, color: 0x8B4513, roughness: 0.6 });
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 3), couchMat); seat.position.y = 0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.5), couchMat); back.position.y = 1.5; back.position.z = -1.25; back.castShadow=true; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armL.position.set(-4.5, 0.75, 0); armL.castShadow=true; couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armR.position.set(4.5, 0.75, 0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); scene.add(couchGroup);

        const avatars = {}; const loader = new THREE.GLTFLoader();

        socket.on('init players', (serverPlayers) => { for(let id in serverPlayers) { spawnAvatar(id, serverPlayers[id]); } });
        socket.on('new player', (p) => { spawnAvatar(p.id, p); });
        socket.on('remove player', (id) => { if(avatars[id]) { scene.remove(avatars[id].mesh); delete avatars[id]; } });
        socket.on('player moved', (data) => {
            if(avatars[data.id]) {
                const av = avatars[data.id]; av.target.set(data.x, 0, data.z); av.mesh.lookAt(data.x, 0, data.z);
                if(av.action !== 'Walking') {
                    if(av.actions['Idle']) av.actions['Idle'].fadeOut(0.2); if(av.actions['Sitting']) av.actions['Sitting'].fadeOut(0.2);
                    if(av.actions['Walking']) av.actions['Walking'].reset().fadeIn(0.2).play(); av.action = 'Walking';
                }
            }
        });

        function spawnAvatar(id, data) {
            if(avatars[id]) return; 
            loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = gltf.scene; model.scale.set(0.4, 0.4, 0.4); model.position.set(data.x, 0, data.z);
                model.traverse((o) => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
                model.userData = { username: data.username, socketId: id };
                scene.add(model);
                const mixer = new THREE.AnimationMixer(model); const actions = {};
                ['Idle', 'Walking', 'Sitting'].forEach(name => { const clip = THREE.AnimationClip.findByName(gltf.animations, name); if(clip) actions[name] = mixer.clipAction(clip); });
                if(actions['Idle']) actions['Idle'].play();
                avatars[id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                if(id === mySocketId) { renderChatLine('system', null, "You have entered the room."); } else { renderChatLine('system', null, `${data.username} has joined.`); }
            });
        }

        function createChatBubble(username, text) {
            let senderMesh = null; for(let id in avatars) { if(avatars[id].mesh.userData.username === username) senderMesh = avatars[id].mesh; }
            if(!senderMesh) return;
            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.0, 0)); headPos.project(camera);
            const x = (headPos.x * .5 + .5) * window.innerWidth; const y = (-(headPos.y * .5) + .5) * window.innerHeight;
            const b = document.createElement('div'); b.className = 'chat-bubble'; b.innerText = text; b.style.left = x+'px'; b.style.top = y+'px';
            document.getElementById('room-view').appendChild(b); setTimeout(()=> { b.remove() }, 3000); 
        }

        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2(); const nodes = []; const seats = [];
        function createNode(x, z, type='walk', y=0.05) {
            const geo = new THREE.CylinderGeometry(type==='seat'?0.4:1, type==='seat'?0.4:1, 0.1, 16);
            const color = 0xffff00; // All yellow
            const mat = new THREE.MeshBasicMaterial({ color: color, opacity: 0.4, transparent: true });
            const node = new THREE.Mesh(geo, mat); node.position.set(x, y, z); node.userData = { type: type, x: x, z: z };
            scene.add(node); nodes.push(node); if(type === 'seat') seats.push(node);
        }
        createNode(-5, 5); createNode(5, 5); createNode(0, 0); createNode(-5, -5); createNode(5, -5); createNode(-2, -5, 'seat', 0.6); createNode(2, -5, 'seat', 0.6);

        renderer.domElement.addEventListener('pointerdown', (e) => {
            if(document.getElementById('room-view').style.display==='none') return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1; mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const nodeHits = raycaster.intersectObjects(nodes);
            if(nodeHits.length > 0) { const d = nodeHits[0].object.userData; socket.emit('move', { x: d.x, z: d.z }); closeAvatarMenu(); return; }
            const avatarMeshes = []; for(let id in avatars) avatarMeshes.push(avatars[id].mesh);
            let hitAvatar = null; const intersects = raycaster.intersectObjects(avatarMeshes, true);
            if(intersects.length > 0) {
                let obj = intersects[0].object; while(obj.parent && obj.parent !== scene) { if(obj.userData && obj.userData.username) { hitAvatar = obj; break; } obj = obj.parent; }
                if(!hitAvatar && obj.userData.username) hitAvatar = obj;
            }
            if(hitAvatar) {
                const menu = document.getElementById('avatar-menu'); document.getElementById('menu-username-display').textContent = hitAvatar.userData.username;
                menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
            } else { closeAvatarMenu(); }
        });

        function closeAvatarMenu() { document.getElementById('avatar-menu').style.display = 'none'; }
        function onWindowResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
        window.onresize = onWindowResize;

        const clock = new THREE.Clock(); const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05; controls.maxPolarAngle = Math.PI / 2 - 0.1; 

        function animate() {
            requestAnimationFrame(animate);
            if(document.getElementById('room-view').style.display!=='none') {
                const delta = clock.getDelta();
                for(let id in avatars) {
                    const av = avatars[id]; if(av.mixer) av.mixer.update(delta);
                    if(av.mesh.position.distanceTo(av.target) > 0.1) { av.mesh.position.lerp(av.target, 0.05); } 
                    else if(av.action === 'Walking') {
                        if(id === mySocketId) socket.emit('stop move'); 
                        let isSitting = false; for(let seat of seats) { const d = Math.hypot(av.mesh.position.x - seat.position.x, av.mesh.position.z - seat.position.z); if(d < 0.5) isSitting = true; }
                        if(av.actions['Walking']) av.actions['Walking'].fadeOut(0.2);
                        if(isSitting) { if(av.actions['Sitting']) av.actions['Sitting'].reset().fadeIn(0.2).play(); av.action = 'Sitting'; av.mesh.rotation.y = Math.PI; } 
                        else { if(av.actions['Idle']) av.actions['Idle'].reset().fadeIn(0.2).play(); av.action = 'Idle'; }
                    }
                }
                controls.update(); renderer.render(scene, camera);
            }
        }
        animate();
    </script>
</body>
</html>
