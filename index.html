<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Blue Chat & Sitting</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* GLOBAL RESET */
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; }

        /* UI OVERLAYS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        
        /* --- MODERN BLUE CHAT PANEL --- */
        #imvu-chat-panel { 
            pointer-events: auto; 
            width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(10,10,25,0.85)); 
            display: flex; 
            flex-direction: column; 
            border-top: 1px solid #00e5ff; 
            box-shadow: 0 -5px 20px rgba(0, 229, 255, 0.15);
            backdrop-filter: blur(5px);
            transition: height 0.3s; 
        }
        
        #exit-btn { 
            pointer-events: auto; position: absolute; top: 15px; right: 15px; 
            background: rgba(255, 68, 68, 0.8); color: white; border: 1px solid #ff4444; 
            border-radius: 4px; padding: 6px 12px; font-weight: bold; font-size: 11px; z-index: 200; 
            transition: 0.2s;
        }
        #exit-btn:hover { background: #ff2222; box-shadow: 0 0 10px #ff2222; }

        /* --- BATTLE HUD (BLUE THEME) --- */
        #battle-hud {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 450px; background: rgba(10, 15, 30, 0.9); border: 1px solid #00e5ff;
            border-radius: 8px; padding: 15px; z-index: 200; pointer-events: auto;
            text-align: center; display: none; 
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
        }
        .hud-title { color: #00e5ff; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 5px #00e5ff; }
        .score-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: monospace; font-size: 14px; }
        .score-box { width: 45%; background: rgba(0, 229, 255, 0.05); padding: 5px; border: 1px solid #333; border-radius: 4px; }
        .score-val { font-size: 24px; font-weight: bold; color: #fff; }
        .mps-val { font-size: 11px; color: #888; }
        .control-row { margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; color: #aaa; font-size: 11px; }

        /* --- 3D BUBBLES --- */
        .chat-bubble {
            position: absolute; background: rgba(255,255,255,0.95); color: #000; padding: 5px 10px; border-radius: 8px;
            font-size: 11px; font-weight: bold; font-family: 'Verdana', sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: none; white-space: nowrap; z-index: 5; 
            animation: floatUp 3s forwards; opacity: 0.9;
        }
        .chat-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0; border-style: solid; border-color: rgba(255,255,255,0.95) transparent transparent transparent; }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* --- AVATAR MENU --- */
        #avatar-menu {
            display: none; position: absolute; width: 180px;
            background-color: rgba(10, 15, 25, 0.95); border: 1px solid #00e5ff;
            border-radius: 6px; box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
            font-size: 13px; z-index: 150; pointer-events: auto; color: #eee; overflow: hidden;
        }
        .menu-header { background: linear-gradient(90deg, #111, #222); padding: 8px 12px; display: flex; align-items: center; border-bottom: 1px solid #333; font-weight: bold; color: #00e5ff; }
        .close-menu { margin-left: auto; cursor: pointer; color: #888; } .close-menu:hover { color: white; }
        .action-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #222; transition: 0.2s; }
        .action-item:hover { background-color: rgba(0, 229, 255, 0.2); color: white; }

        /* AUTH & DASHBOARD STYLES */
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a2e, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 320px; padding: 40px; background: rgba(255, 255, 255, 0.05); border: 1px solid #333; border-radius: 12px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .auth-input { width: 90%; padding: 12px; margin-bottom: 15px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; font-size: 14px; transition: 0.3s; }
        .auth-input:focus { border-color: #00e5ff; box-shadow: 0 0 8px rgba(0, 229, 255, 0.3); }
        .auth-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #00e5ff, #007ae5); border: none; font-weight: bold; color: white; border-radius: 6px; font-size: 16px; transition: 0.3s; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 122, 229, 0.4); }
        .link-text { margin-top: 20px; font-size: 13px; color: #888; cursor: pointer; text-decoration: none; }
        .error-msg { color: #ff5555; font-size: 13px; margin-bottom: 15px; display: none; background: rgba(255,85,85,0.1); padding: 5px; border-radius: 4px; }
        
        #signup-view, #dashboard-view, #room-view { display: none; }
        #login-view { display: flex; }
        
        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #111, #000); z-index: 50; }
        #menu-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dashboard-btn { width: 160px; height: 140px; background: linear-gradient(145deg, #222, #151515); border: 1px solid #333; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .dashboard-btn:hover { border-color: #00e5ff; transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 229, 255, 0.15); }

        /* --- BLUE CHAT CSS (STANDARD ANIMATION) --- */
        #chat-interface-wrapper { display: block; padding: 10px 20px; }
        
        #chat-history { 
            height: 200px; 
            overflow-y: scroll; 
            margin-bottom: 10px;
            font-size: 13px; 
            line-height: 1.6; 
            color: #ddd; 
            scrollbar-width: thin; 
            scrollbar-color: #00e5ff transparent; 
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-thumb { background-color: #00e5ff; border-radius: 3px; }

        /* Smooth Slide-In Animation (Standard) */
        @keyframes smoothSlideIn {
            0% { opacity: 0; transform: translateX(-15px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        .chat-line { 
            margin-bottom: 5px; 
            display: block; 
            animation: smoothSlideIn 0.3s ease-out forwards;
        }

        .username { color: #00e5ff; font-weight: bold; cursor: pointer; margin-right: 5px; text-shadow: 0 0 5px rgba(0, 229, 255, 0.3); }
        .message-text { color: #eee; }
        .system-msg { color: #888; font-style: italic; font-size: 12px; } 
        
        #input-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 30px; padding: 5px 5px 5px 15px; }
        #msgInput { flex-grow: 1; background: transparent; border: none; color: white; padding: 8px 0; font-size: 13px; }
        #send-btn { background: #00e5ff; color: #000; border: none; font-weight: bold; font-size: 12px; padding: 8px 20px; border-radius: 20px; margin-left: 10px; transition: 0.2s; }
        #send-btn:hover { background: #fff; box-shadow: 0 0 10px #fff; }
        
        #toolbar { height: 40px; background-color: rgba(0,0,0,0.3); display: flex; align-items: center; padding-left: 15px; border-top: 1px solid #333; }
        .icon { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #888; cursor: pointer; transition: 0.2s; }
        .icon:hover { color: white; }
        .icon.active { color: #00e5ff; text-shadow: 0 0 10px #00e5ff; }
        
        #scroll-notice { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: #00e5ff; color: black; font-weight: bold; font-size: 11px; padding: 4px 10px; border-radius: 10px; display: none; z-index: 500; }
    </style>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>

    <!-- BATTLE HUD -->
    <div id="battle-hud">
        <div class="hud-title">Server Stats</div>
        <div class="score-row">
            <div class="score-box" style="border-color: #00e5ff;">
                <div style="color:#00e5ff; font-size:11px; font-weight:bold;">YOU</div>
                <div class="score-val" id="my-score">0</div>
                <div class="mps-val" id="my-mps">0 MPS</div>
            </div>
            <div class="score-box" style="border-color: #ff5555;">
                <div style="color:#ff5555; font-size:11px; font-weight:bold;">GLOBAL</div>
                <div class="score-val" id="global-score">0</div>
            </div>
        </div>
        <div class="control-row">
            <p>Click yellow nodes on the couch to sit.</p>
            <button onclick="resetBattleScores()" style="background:transparent; color:#888; border:1px solid #555; padding:4px 10px; border-radius:4px; font-size:10px;">RESET</button>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 28px; color: white; font-weight: bold; margin-bottom: 25px;">IMVU: Blue World</div>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">ENTER WORLD</button>
            <div class="link-text" onclick="showSignup()">Create new account</div>
        </div>
    </div>

    <!-- SIGNUP SCREEN -->
    <div id="signup-view" class="auth-container">
        <div class="auth-box">
            <div class="auth-title" style="font-size: 28px; color: white; font-weight: bold; margin-bottom: 25px;">Join the Grid</div>
            <div id="signup-error" class="error-msg">Username taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="Choose Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Create Password">
            <button class="auth-btn" onclick="handleSignup()">REGISTER</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="dashboard-view">
        <div id="menu-area">
            <h1 style="color:white; font-size: 40px; margin-bottom: 40px; text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);">WELCOME TO THE LOBBY</h1>
            <div id="button-grid">
                <div class="dashboard-btn" onclick="enterRoom()">
                    <div class="btn-icon">ðŸ¤–</div>
                    <div class="btn-text">Connect to Server</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME ROOM -->
    <div id="room-view">
        <!-- 3D Canvas -->
        <div id="canvas-container" style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; background:#000;"></div>
        
        <!-- Context Menu -->
        <div id="avatar-menu">
            <div class="menu-header" id="menu-header-handle">
                <span id="menu-username-display">User</span> 
                <span class="close-menu" onclick="closeAvatarMenu()">âœ–</span>
            </div>
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Trade</div>
        </div>

        <button id="exit-btn" onclick="exitRoom()">âœ– DISCONNECT</button>
        
        <!-- BLUE CHAT UI -->
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="scroll-notice">â‡© New Messages â‡©</div>
                    <div id="input-row">
                        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">SEND</button>
                    </div>
                    <div style="font-size:10px; color:#666; margin-top:5px; margin-left: 10px;">
                        <label><input type="checkbox" id="focus-lock-check" checked> Auto-focus chat</label>
                    </div>
                </div>
                <div id="toolbar">
                    <div class="icon active" id="chat-icon" onclick="toggleChatWindow()">ðŸ’¬</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SOCKET SETUP ---
        const socket = io();
        let currentUser = "Guest";
        let mySocketId = null; 

        socket.on('connect', () => {
            mySocketId = socket.id;
        });

        // --- AUTH LOGIC ---
        function showSignup() { document.getElementById('login-view').style.display='none'; document.getElementById('signup-view').style.display='flex'; }
        function showLogin() { document.getElementById('signup-view').style.display='none'; document.getElementById('login-view').style.display='flex'; }
        
        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success){ currentUser=data.username; document.getElementById('login-view').style.display='none'; document.getElementById('dashboard-view').style.display='flex'; }
            else { showError('login-error', data.msg); }
        }
        async function handleSignup() {
            const u = document.getElementById('signup-user').value;
            const p = document.getElementById('signup-pass').value;
            const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
            const data = await res.json();
            if(data.success) { alert("Registered! Please login."); showLogin(); }
            else { showError('signup-error', data.msg); }
        }
        function showError(id, msg) {
            const el = document.getElementById(id);
            el.style.display = 'block'; el.innerText = msg;
            setTimeout(()=>el.style.display='none', 3000);
        }

        // --- ROOM MANAGEMENT ---
        const dashboard = document.getElementById('dashboard-view');
        const room = document.getElementById('room-view');
        const battleHud = document.getElementById('battle-hud');

        function enterRoom() {
            dashboard.style.display='none'; room.style.display='block'; battleHud.style.display='block';
            onWindowResize();
            socket.emit('join game', currentUser);
            setInterval(calculateMPS, 1000);
        }
        function exitRoom() { location.reload(); }

        let isChatOpen = true;
        function toggleChatWindow() {
            const wrapper = document.getElementById('chat-interface-wrapper');
            if(isChatOpen) { wrapper.style.display='none'; isChatOpen=false; document.getElementById('chat-icon').classList.remove('active'); }
            else { wrapper.style.display='block'; isChatOpen=true; document.getElementById('chat-icon').classList.add('active'); }
        }

        // --- CHAT LOGIC ---
        const chatBox = document.getElementById('chat-history');
        const input = document.getElementById('msgInput');
        const focusLockCheck = document.getElementById('focus-lock-check');
        const scrollNotice = document.getElementById('scroll-notice');
        
        input.addEventListener('blur', () => { if(focusLockCheck.checked && room.style.display!=='none') setTimeout(()=>input.focus(), 10); });

        socket.on('chat message', (data) => {
            renderChatLine('chat', data.username, data.message);
            trackMessage(data.username === currentUser);
        });

        socket.on('system message', (msg) => { renderChatLine('system', null, msg); });

        function renderChatLine(type, username, text) {
            const tolerance = 20;
            const isUserAtBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < tolerance;
            const msgDiv = document.createElement('div');
            
            // Standard smooth entry for everything, NO spam logic
            msgDiv.className = `chat-line`;
            
            if (type === 'system') msgDiv.innerHTML = `<span class="system-msg">â˜… ${text}</span>`;
            else {
                msgDiv.innerHTML = `<span class="username">${username}</span> <span class="message-text">${text}</span>`;
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv); 
            
            if (isUserAtBottom) { chatBox.scrollTop = chatBox.scrollHeight; scrollNotice.style.display = 'none'; }
            else { scrollNotice.style.display = 'block'; }
        }

        function sendMsg() {
            const val = input.value;
            if(val) {
                socket.emit('chat message', { username: currentUser, message: val });
                input.value = '';
            }
        }
        input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMsg(); });

        // --- STATISTICS ---
        let myTotal = 0; let globalTotal = 0; let myPacketsThisSec = 0;
        function trackMessage(isMe) {
            globalTotal++;
            document.getElementById('global-score').innerText = globalTotal;
            if(isMe) { myTotal++; myPacketsThisSec++; document.getElementById('my-score').innerText = myTotal; }
        }
        function calculateMPS() {
            document.getElementById('my-mps').innerText = myPacketsThisSec + " MPS";
            myPacketsThisSec = 0; 
        }
        function resetBattleScores() { myTotal=0; globalTotal=0; document.getElementById('my-score').innerText="0"; document.getElementById('global-score').innerText="0"; }

        // =========================================================
        //          3D SCENE & TEXTURED COUCH
        // =========================================================
        const container = document.getElementById('canvas-container');
        
        // Scene & Fog
        const scene = new THREE.Scene(); 
        scene.background = new THREE.Color(0x101020); 
        scene.fog = new THREE.Fog(0x101020, 10, 50);

        // Camera
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 8, 15); 

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = true; 
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
        container.appendChild(renderer.domElement);

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 20; dirLight.shadow.camera.bottom = -20;
        dirLight.shadow.camera.left = -20; dirLight.shadow.camera.right = 20;
        dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // Textures
        const texLoader = new THREE.TextureLoader();
        const leatherTex = texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/disturb.jpg');
        leatherTex.wrapS = leatherTex.wrapT = THREE.RepeatWrapping;
        leatherTex.repeat.set(2, 2);

        // Environment
        const grid = new THREE.GridHelper(100, 100, 0x00e5ff, 0x222222);
        grid.position.y = 0.01; grid.material.opacity = 0.2; grid.material.transparent = true;
        scene.add(grid);

        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2;
        floor.receiveShadow = true;
        scene.add(floor);

        // --- COUCH WITH TEXTURE ---
        const couchGroup = new THREE.Group();
        const couchMat = new THREE.MeshStandardMaterial({ 
            map: leatherTex, 
            color: 0x8B4513, // SaddleBrown
            roughness: 0.6 
        });
        
        const seat = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 3), couchMat); seat.position.y = 0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.5), couchMat); back.position.y = 1.5; back.position.z = -1.25; back.castShadow=true; couchGroup.add(back);
        const armL = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armL.position.set(-4.5, 0.75, 0); armL.castShadow=true; couchGroup.add(armL);
        const armR = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 3), couchMat); armR.position.set(4.5, 0.75, 0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); 
        scene.add(couchGroup);

        // --- AVATAR SYSTEM ---
        const avatars = {}; 
        const loader = new THREE.GLTFLoader();

        socket.on('init players', (serverPlayers) => {
            for(let id in serverPlayers) {
                spawnAvatar(id, serverPlayers[id]);
            }
        });
        
        socket.on('new player', (p) => {
            spawnAvatar(p.id, p);
        });
        
        socket.on('remove player', (id) => {
            if(avatars[id]) { scene.remove(avatars[id].mesh); delete avatars[id]; }
        });

        socket.on('player moved', (data) => {
            if(avatars[data.id]) {
                const av = avatars[data.id];
                av.target.set(data.x, 0, data.z);
                av.mesh.lookAt(data.x, 0, data.z);
                
                if(av.action !== 'Walking') {
                    if(av.actions['Idle']) av.actions['Idle'].fadeOut(0.2);
                    if(av.actions['Sitting']) av.actions['Sitting'].fadeOut(0.2);
                    if(av.actions['Walking']) av.actions['Walking'].reset().fadeIn(0.2).play();
                    av.action = 'Walking';
                }
            }
        });

        socket.on('player stop', (id) => {
             // Handled locally
        });

        function spawnAvatar(id, data) {
            if(avatars[id]) return; 

            loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/RobotExpressive/RobotExpressive.glb', (gltf) => {
                const model = gltf.scene;
                model.scale.set(0.4, 0.4, 0.4);
                model.position.set(data.x, 0, data.z);
                model.traverse((o) => { if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
                model.userData = { username: data.username, socketId: id };

                scene.add(model);

                const mixer = new THREE.AnimationMixer(model);
                const actions = {};
                
                ['Idle', 'Walking', 'Sitting'].forEach(name => {
                    const clip = THREE.AnimationClip.findByName(gltf.animations, name);
                    if(clip) actions[name] = mixer.clipAction(clip);
                });
                
                if(actions['Idle']) actions['Idle'].play();

                avatars[id] = { mesh: model, mixer, actions, action: 'Idle', target: new THREE.Vector3(data.x,0,data.z) };
                
                if(id === mySocketId) {
                    renderChatLine('system', null, "You have entered the room.");
                } else {
                    renderChatLine('system', null, `${data.username} has joined.`);
                }
            });
        }

        function createChatBubble(username, text) {
            let senderMesh = null;
            for(let id in avatars) {
                if(avatars[id].mesh.userData.username === username) senderMesh = avatars[id].mesh;
            }
            if(!senderMesh) return;
            
            const headPos = senderMesh.position.clone().add(new THREE.Vector3(0, 2.0, 0));
            headPos.project(camera);
            
            const x = (headPos.x * .5 + .5) * window.innerWidth;
            const y = (-(headPos.y * .5) + .5) * window.innerHeight;

            const b = document.createElement('div');
            b.className = 'chat-bubble'; b.innerText = text;
            b.style.left = x+'px'; b.style.top = y+'px';
            room.appendChild(b);
            
            setTimeout(()=> { b.remove() }, 3000); 
        }

        // --- INTERACTION & SITTING NODES ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        const nodes = [];
        const seats = [];

        function createNode(x, z, type='walk', y=0.05) {
            const geo = new THREE.CylinderGeometry(type==='seat'?0.4:1, type==='seat'?0.4:1, 0.1, 16);
            const color = type==='seat' ? 0xffff00 : 0x00e5ff;
            const mat = new THREE.MeshBasicMaterial({ color: color, opacity: 0.4, transparent: true });
            const node = new THREE.Mesh(geo, mat);
            node.position.set(x, y, z);
            node.userData = { type: type, x: x, z: z };
            scene.add(node);
            nodes.push(node);
            if(type === 'seat') seats.push(node);
        }

        // Floor Nodes
        createNode(-5, 5); createNode(5, 5); createNode(0, 0); createNode(-5, -5); createNode(5, -5);
        // Seat Nodes
        createNode(-2, -5, 'seat', 0.6);
        createNode(2, -5, 'seat', 0.6);

        renderer.domElement.addEventListener('pointerdown', (e) => {
            if(room.style.display==='none') return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // 1. Check Movement/Seat Nodes
            const nodeHits = raycaster.intersectObjects(nodes);
            if(nodeHits.length > 0) {
                const d = nodeHits[0].object.userData;
                socket.emit('move', { x: d.x, z: d.z });
                closeAvatarMenu();
                return;
            }

            // 2. Check Avatar Clicks (Menu)
            const avatarMeshes = [];
            for(let id in avatars) avatarMeshes.push(avatars[id].mesh);
            
            let hitAvatar = null;
            const intersects = raycaster.intersectObjects(avatarMeshes, true);
            if(intersects.length > 0) {
                let obj = intersects[0].object;
                while(obj.parent && obj.parent !== scene) {
                    if(obj.userData && obj.userData.username) { hitAvatar = obj; break; }
                    obj = obj.parent;
                }
                if(!hitAvatar && obj.userData.username) hitAvatar = obj;
            }

            if(hitAvatar) {
                const menu = document.getElementById('avatar-menu');
                document.getElementById('menu-username-display').textContent = hitAvatar.userData.username;
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px';
            } else {
                closeAvatarMenu();
            }
        });

        function closeAvatarMenu() { document.getElementById('avatar-menu').style.display = 'none'; }
        function onWindowResize() {
            camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth,window.innerHeight);
        }
        window.onresize = onWindowResize;

        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; 

        function animate() {
            requestAnimationFrame(animate);
            if(room.style.display!=='none') {
                const delta = clock.getDelta();
                for(let id in avatars) {
                    const av = avatars[id];
                    if(av.mixer) av.mixer.update(delta);
                    
                    if(av.mesh.position.distanceTo(av.target) > 0.1) {
                        av.mesh.position.lerp(av.target, 0.05);
                    } else if(av.action === 'Walking') {
                        if(id === mySocketId) socket.emit('stop move'); 
                        
                        let isSitting = false;
                        for(let seat of seats) {
                            const d = Math.hypot(av.mesh.position.x - seat.position.x, av.mesh.position.z - seat.position.z);
                            if(d < 0.5) isSitting = true;
                        }

                        if(av.actions['Walking']) av.actions['Walking'].fadeOut(0.2);

                        if(isSitting) {
                            if(av.actions['Sitting']) av.actions['Sitting'].reset().fadeIn(0.2).play();
                            av.action = 'Sitting';
                            av.mesh.rotation.y = Math.PI; 
                        } else {
                            if(av.actions['Idle']) av.actions['Idle'].reset().fadeIn(0.2).play();
                            av.action = 'Idle';
                        }
                    }
                }
                controls.update();
                renderer.render(scene, camera);
            }
        }
        animate();
    </script>
</body>
</html>
