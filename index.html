<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Avatar Edition</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #ui-layer { position: absolute; bottom: 0; width: 100%; z-index: 10; }
        #chat-panel { background: rgba(0,0,0,0.8); color: white; padding: 10px; display: flex; flex-direction: column; }
        #chat-history { height: 150px; overflow-y: auto; font-size: 14px; margin-bottom: 5px; }
        #input-row { display: flex; }
        #msgInput { flex-grow: 1; padding: 8px; }
        #login-screen { position: absolute; width: 100%; height: 100%; background: #111; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .btn { padding: 10px 20px; background: #00e5ff; border: none; cursor: pointer; font-weight: bold; }
        #avatar-menu { display: none; position: absolute; background: white; color: black; padding: 10px; border-radius: 5px; z-index: 20; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>IMVU CLONE</h1>
        <input type="text" id="username" placeholder="Enter Username..." style="padding:10px; margin-bottom:10px;">
        <button class="btn" onclick="start()">ENTER WORLD</button>
    </div>

    <div id="room-view" style="display:none;">
        <div id="canvas-container"></div>
        <div id="avatar-menu">
            <b id="menu-user">User</b><br>
            <button onclick="document.getElementById('avatar-menu').style.display='none'">Close</button>
        </div>
        <div id="ui-layer">
            <div id="chat-panel">
                <div id="chat-history"></div>
                <div id="input-row">
                    <input type="text" id="msgInput" placeholder="Type a message...">
                    <button class="btn" onclick="sendMsg()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myId, currentUser;
        const avatars = {};

        // 3D Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
        scene.add(light);
        const grid = new THREE.GridHelper(20, 20);
        scene.add(grid);

        const loader = new THREE.GLTFLoader();

        function start() {
            currentUser = document.getElementById('username').value || "Guest";
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            socket.emit('join game', currentUser);
            animate();
        }

        socket.on('connect', () => { myId = socket.id; });

        socket.on('init players', (serverPlayers) => {
            for(let id in serverPlayers) spawnAvatar(id, serverPlayers[id]);
        });

        socket.on('new player', (data) => spawnAvatar(data.id, data));

        socket.on('remove player', (id) => {
            if(avatars[id]) { scene.remove(avatars[id].mesh); delete avatars[id]; }
        });

        function spawnAvatar(id, data) {
            // !!! CHANGE THIS TO YOUR FILENAME !!!
            const modelPath = 'models/male_avatar.glb'; 

            loader.load(modelPath, (gltf) => {
                const model = gltf.scene;
                
                // Blender models are usually large. 0.5 or 0.1 is usually good.
                model.scale.set(0.5, 0.5, 0.5); 
                model.position.set(data.x, 0, data.z);
                model.userData = { username: data.username };
                
                scene.add(model);

                const mixer = new THREE.AnimationMixer(model);
                const actions = {};
                gltf.animations.forEach(clip => { actions[clip.name] = mixer.clipAction(clip); });
                
                // Play first available animation
                if (gltf.animations.length > 0) actions[gltf.animations[0].name].play();

                avatars[id] = { mesh: model, mixer, target: new THREE.Vector3(data.x, 0, data.z) };
            });
        }

        // Movement
        window.addEventListener('mousedown', (e) => {
            const mouse = new THREE.Vector2( (e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1 );
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(grid);
            if(intersects.length > 0) {
                const pt = intersects[0].point;
                socket.emit('move', { x: pt.x, z: pt.z });
            }
        });

        socket.on('player moved', (data) => {
            if(avatars[data.id]) {
                avatars[data.id].target.set(data.x, 0, data.z);
                avatars[data.id].mesh.lookAt(data.x, 0, data.z);
            }
        });

        // Chat
        function sendMsg() {
            const m = document.getElementById('msgInput').value;
            if(m) { socket.emit('chat message', { u: currentUser, m: m }); document.getElementById('msgInput').value = ''; }
        }

        socket.on('chat message', (data) => {
            const h = document.getElementById('chat-history');
            h.innerHTML += `<div><b>${data.u}:</b> ${data.m}</div>`;
            h.scrollTop = h.scrollHeight;
        });

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            for(let id in avatars) {
                if(avatars[id].mixer) avatars[id].mixer.update(delta);
                avatars[id].mesh.position.lerp(avatars[id].target, 0.1);
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
