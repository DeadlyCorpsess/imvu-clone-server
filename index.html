<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Robot World</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* --- PREMIUM BLUE GLASS THEME --- */
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Segoe UI', Arial, sans-serif; color: white; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        
        /* Blue Glass Chat Panel */
        #imvu-chat-panel { 
            pointer-events: auto; width: 100%; background-color: rgba(0, 15, 30, 0.85); 
            display: flex; flex-direction: column; border-top: 2px solid #00e5ff; 
            backdrop-filter: blur(12px); box-shadow: 0 -5px 25px rgba(0, 229, 255, 0.2);
        }
        
        #chat-interface-wrapper { padding: 15px; }
        #chat-history { height: 180px; overflow-y: auto; margin-bottom: 10px; font-size: 14px; line-height: 1.5; color: #eee; }
        .username { color: #00e5ff; font-weight: bold; margin-right: 8px; text-shadow: 0 0 5px rgba(0, 229, 255, 0.5); }

        #input-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); border-radius: 25px; padding: 5px 15px; border: 1px solid #333; }
        #msgInput { flex-grow: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 14px; outline: none; }
        #send-btn { background: #00e5ff; color: #000; border: none; font-weight: bold; padding: 8px 22px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        #send-btn:hover { background: #fff; transform: scale(1.05); }

        /* HUD */
        #battle-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 350px; background: rgba(10, 10, 20, 0.9); border: 1px solid #00e5ff;
            border-radius: 10px; padding: 12px; z-index: 200; text-align: center; display: none;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
        }

        /* Views */
        .auth-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #001a33, #000); display: flex; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 340px; padding: 40px; background: rgba(0, 0, 0, 0.6); border: 1px solid #00e5ff; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); }
        .auth-input { width: 90%; padding: 12px; margin-bottom: 20px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; text-align: center; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; background: linear-gradient(90deg, #00e5ff, #008cff); border: none; font-weight: bold; color: #000; border-radius: 8px; font-size: 16px; cursor: pointer; }

        #dashboard-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 150; display:none; flex-direction: column; align-items: center; justify-content: center; }
        .dashboard-btn { width: 220px; padding: 40px; background: #0a0a0a; border: 2px solid #00e5ff; border-radius: 20px; cursor: pointer; text-align: center; transition: 0.4s; box-shadow: 0 0 15px rgba(0, 229, 255, 0.1); }
        .dashboard-btn:hover { background: #00e5ff; color: #000; transform: translateY(-10px); }
    </style>
</head>
<body>

    <div id="battle-hud">
        <div style="color:#00e5ff; font-weight:bold; letter-spacing: 3px; font-size: 12px;">GRID STATUS: ACTIVE</div>
        <div style="display:flex; justify-content: space-around; margin-top:12px;">
            <div><small style="color:#888;">AVATAR</small><div id="hud-user" style="font-size:18px; color:#fff;">-</div></div>
            <div><small style="color:#888;">PACKETS</small><div id="my-score" style="font-size:18px; color:#fff;">0</div></div>
        </div>
    </div>

    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <h1 style="color:#00e5ff; margin-bottom:30px; letter-spacing:2px;">IMVU CLONE</h1>
            <input type="text" id="login-user" class="auth-input" placeholder="Choose Username">
            <button class="auth-btn" onclick="handleLogin()">AUTHENTICATE</button>
        </div>
    </div>

    <div id="dashboard-view">
        <h1 style="font-size:42px; color:white; margin-bottom:50px; text-shadow: 0 0 20px rgba(0,229,255,0.5);">THE GRID IS READY</h1>
        <div class="dashboard-btn" onclick="enterRoom()">
            <div style="font-size:50px;">ðŸ›¸</div>
            <div style="font-weight:bold; margin-top:15px; letter-spacing:1px;">ENTER WORLD</div>
        </div>
    </div>

    <div id="room-view" style="display:none;">
        <div id="canvas-container" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
        
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div id="chat-interface-wrapper">
                    <div id="chat-history"></div>
                    <div id="input-row">
                        <input type="text" id="msgInput" placeholder="Type a message to the world..." autocomplete="off">
                        <button id="send-btn" onclick="sendMsg()">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = "Guest";
        const avatars = {};

        function handleLogin() {
            currentUser = document.getElementById('login-user').value || "Guest";
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'flex';
        }

        function enterRoom() {
            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            document.getElementById('battle-hud').style.display = 'block';
            document.getElementById('hud-user').innerText = currentUser;
            socket.emit('join game', currentUser);
            animate();
        }

        // --- THREE.JS ENGINE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding; // Critical for correct colors
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- STUDIO LIGHTING (Matches GIF) ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(5, 10, 7);
        scene.add(sun);

        const rimLight = new THREE.PointLight(0x00e5ff, 1, 15);
        rimLight.position.set(-5, 5, -5);
        scene.add(rimLight);

        const grid = new THREE.GridHelper(60, 60, 0x00e5ff, 0x0a0a0a);
        scene.add(grid);

        const loader = new THREE.GLTFLoader();

        function spawnAvatar(id, data) {
            if(avatars[id]) return;

            // Load Blender GLB
            loader.load('models/male_avatar.glb', (gltf) => {
                const model = gltf.scene;
                
                // Fix Scaling (Blender is 100x bigger than ThreeJS default)
                model.scale.set(0.01, 0.01, 0.01); 
                model.position.set(data.x, 0, data.z);

                // TEXTURE & MATERIAL FIXER (Ensures skin looks like the GIF)
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.metalness = 0.1; 
                        child.material.roughness = 0.7; 
                        child.material.envMapIntensity = 1.0;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                scene.add(model);

                // ANIMATION HANDLER (Breathing / Swaying)
                const mixer = new THREE.AnimationMixer(model);
                
                // Auto-find Idle or Breathing animation
                let idleClip = gltf.animations.find(a => 
                    a.name.toLowerCase().includes('idle') || 
                    a.name.toLowerCase().includes('breath') ||
                    a.name.toLowerCase().includes('sway')
                );

                if (!idleClip && gltf.animations.length > 0) idleClip = gltf.animations[0];

                if (idleClip) {
                    const action = mixer.clipAction(idleClip);
                    action.fadeIn(0.5).play();
                }

                avatars[id] = { mesh: model, mixer };
            });
        }

        // --- NETWORK EVENTS ---
        socket.on('init players', (p) => { for(let id in p) spawnAvatar(id, p[id]); });
        socket.on('new player', (p) => spawnAvatar(p.id, p));
        socket.on('remove player', (id) => { if(avatars[id]){ scene.remove(avatars[id].mesh); delete avatars[id]; } });

        // --- CHAT SYSTEM ---
        let packetsSent = 0;
        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(val) {
                socket.emit('chat message', { username: currentUser, message: val });
                document.getElementById('msgInput').value = '';
            }
        }
        
        socket.on('chat message', (data) => {
            if(data.username === currentUser) {
                packetsSent++;
                document.getElementById('my-score').innerText = packetsSent;
            }
            const hist = document.getElementById('chat-history');
            const line = document.createElement('div');
            line.style.padding = "4px 0";
            line.innerHTML = `<span class="username">${data.username}:</span> <span>${data.message}</span>`;
            hist.appendChild(line);
            hist.scrollTop = hist.scrollHeight;
        });

        // --- GAME LOOP ---
        const clock = new THREE.Clock();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 2;
        controls.maxDistance = 20;

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            // Update animations for all players
            for(let id in avatars) {
                if(avatars[id].mixer) avatars[id].mixer.update(delta);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        // Listen for Enter Key
        document.getElementById('msgInput').addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMsg();
        });

        // Responsiveness
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
