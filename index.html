<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Classic Interface</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* --- CLASSIC BLACK & YELLOW THEME --- */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: Arial, sans-serif; color: white; }
        
        #ui-layer { 
            position: absolute; bottom: 0; left: 0; width: 100%; z-index: 10; 
            display: flex; flex-direction: column; pointer-events: none;
        }

        /* Chat History Overlay (Floats above the bar) */
        #chat-history { 
            height: 150px; overflow-y: auto; padding: 10px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            pointer-events: auto; font-size: 13px; text-shadow: 1px 1px 2px #000;
        }
        .chat-line { margin-bottom: 4px; animation: fadeIn 0.3s ease; }
        .username { color: #f5d300; font-weight: bold; margin-right: 5px; }

        /* The Main Bottom Bar */
        #imvu-bottom-bar {
            background: #000;
            border-top: 1px solid #f5d300; /* The yellow line from your image */
            padding: 5px 0;
            pointer-events: auto;
        }

        /* Input Section */
        #input-row { 
            display: flex; align-items: center; padding: 2px 10px; gap: 5px;
        }
        #msgInput { 
            flex-grow: 1; background: #111; border: 1px solid #333; 
            color: #ccc; padding: 6px 12px; font-size: 14px; outline: none;
        }
        #send-btn { 
            background: #f5d300; color: #000; border: none; 
            padding: 6px 15px; font-weight: bold; cursor: pointer; border-radius: 2px;
        }

        /* Icon Tray (Centered below input) */
        #icon-tray {
            display: flex; justify-content: center; align-items: center;
            gap: 20px; padding: 5px 0; margin-top: 5px;
        }
        .tray-icon {
            width: 24px; height: 24px; cursor: pointer; opacity: 0.7; transition: 0.2s;
            filter: invert(1); /* Makes icons white */
        }
        .tray-icon:hover { opacity: 1; transform: scale(1.1); }
        .tray-icon.active { 
            filter: none; opacity: 1; 
            background: #f5d300; border-radius: 50%; padding: 5px;
            box-shadow: 0 0 10px rgba(245, 211, 0, 0.5);
        }

        /* Auth/Dashboard (Kept from original) */
        .auth-container { position: absolute; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 300px; text-align: center; border: 1px solid #f5d300; padding: 30px; }
        .auth-input { width: 80%; padding: 10px; margin: 10px 0; background: #111; border: 1px solid #444; color: #fff; }
        .auth-btn { width: 80%; padding: 10px; background: #f5d300; border: none; cursor: pointer; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <h2 style="color:#f5d300">IMVU CLONE</h2>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <button class="auth-btn" onclick="enterRoom()">ENTER WORLD</button>
        </div>
    </div>

    <div id="room-view" style="display:none;">
        <div id="canvas-container" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
        
        <div id="ui-layer">
            <!-- Chat Messages -->
            <div id="chat-history"></div>

            <!-- The Interface from your image -->
            <div id="imvu-bottom-bar">
                <div id="input-row">
                    <input type="text" id="msgInput" placeholder="Type message here..." autocomplete="off">
                    <button id="send-btn" onclick="sendMsg()">Send</button>
                </div>

                <div id="icon-tray">
                    <!-- Chat Icon (Active) -->
                    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" class="tray-icon active">
                    <!-- Clothes Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/3159/3159620.png" class="tray-icon">
                    <!-- Hanger Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/1067/1067555.png" class="tray-icon">
                    <!-- Chair Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/2800/2800458.png" class="tray-icon">
                    <!-- House Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="tray-icon">
                    <!-- Music Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/4430/4430705.png" class="tray-icon">
                    <!-- Camera Icon -->
                    <img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" class="tray-icon">
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = "Guest";
        const avatars = {};

        function enterRoom() {
            currentUser = document.getElementById('login-user').value || "Guest";
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            socket.emit('join game', currentUser);
            animate();
        }

        // --- THREE.JS ENGINE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x050505);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const light = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(light);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);

        // Floor Grid
        const grid = new THREE.GridHelper(20, 20, 0x333333, 0x111111);
        scene.add(grid);

        const loader = new THREE.GLTFLoader();

        function spawnAvatar(id, data) {
            if(avatars[id]) return;

            // Using a simple box if model fails, but keeping your GLB logic
            loader.load('models/male_avatar.glb', (gltf) => {
                const model = gltf.scene;
                model.scale.set(1, 1, 1);
                model.position.set(data.x || 0, 0, data.z || 0);
                scene.add(model);

                const mixer = new THREE.AnimationMixer(model);
                if(gltf.animations.length > 0) {
                    mixer.clipAction(gltf.animations[0]).play();
                }

                avatars[id] = { 
                    mesh: model, 
                    mixer: mixer,
                    // Store initial rotation for procedural animation
                    baseRot: model.rotation.y,
                    seed: Math.random() * 100 
                };
            }, undefined, (err) => {
                // Fallback: If no model found, show a placeholder
                const geo = new THREE.CapsuleGeometry(0.4, 1, 4, 8);
                const mat = new THREE.MeshStandardMaterial({ color: 0xf5d300 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(0, 1, 0);
                scene.add(mesh);
                avatars[id] = { mesh: mesh, seed: Math.random() * 100 };
            });
        }

        // --- PROCEDURAL ANIMATION SYSTEM ---
        // This makes characters move without needing external files
        function applyProceduralAnimation(avatar, time) {
            if (!avatar.mesh) return;
            
            const s = avatar.seed;
            // 1. Breathing (Subtle scaling)
            const breath = Math.sin(time * 2 + s) * 0.02;
            avatar.mesh.scale.set(1 + breath, 1 + breath, 1 + breath);

            // 2. Idle Sway (Gentle tilt)
            avatar.mesh.rotation.z = Math.sin(time * 0.5 + s) * 0.03;
            
            // 3. Hovering (If it's a "Robot World")
            avatar.mesh.position.y = (Math.sin(time * 1.5 + s) * 0.05) + 0; 
        }

        // --- NETWORK & CHAT ---
        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(val) {
                socket.emit('chat message', { username: currentUser, message: val });
                document.getElementById('msgInput').value = '';
            }
        }

        socket.on('chat message', (data) => {
            const hist = document.getElementById('chat-history');
            const line = document.createElement('div');
            line.className = 'chat-line';
            line.innerHTML = `<span class="username">${data.username}:</span> ${data.message}`;
            hist.appendChild(line);
            hist.scrollTop = hist.scrollHeight;
        });

        socket.on('init players', (p) => { for(let id in p) spawnAvatar(id, p[id]); });
        socket.on('new player', (p) => spawnAvatar(p.id, p));

        // --- LOOP ---
        const clock = new THREE.Clock();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const elapsed = clock.getElapsedTime();
            
            for(let id in avatars) {
                // Update imported animations
                if(avatars[id].mixer) avatars[id].mixer.update(delta);
                
                // Apply our "no-export" procedural animations
                applyProceduralAnimation(avatars[id], elapsed);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('msgInput').addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMsg();
        });
    </script>
</body>
</html>
