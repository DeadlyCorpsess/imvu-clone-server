<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Robot World</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* --- PREMIUM THEME --- */
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Segoe UI', Arial, sans-serif; color: white; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        
        /* SOLID BLACK CHAT */
        #chat-history { 
            height: 200px; overflow-y: auto; padding: 15px 25px; 
            background: #000000; pointer-events: auto; font-size: 14px; 
            border-top: 1px solid #1a1a1a;
        }
        .chat-line { margin-bottom: 6px; }
        .username { color: #f5d300; font-weight: bold; margin-right: 8px; }

        /* YELLOW BOTTOM BAR */
        #imvu-bottom-bar {
            background: #000; border-top: 1px solid #f5d300;
            padding: 10px 0; pointer-events: auto;
        }
        #input-row { display: flex; align-items: center; padding: 0 15px; gap: 10px; }
        #msgInput { 
            flex-grow: 1; background: #0a0a0a; border: 1px solid #333; 
            color: #ddd; padding: 9px 15px; font-size: 14px; outline: none; 
        }
        #send-btn { background: #f5d300; color: #000; border: none; font-weight: bold; padding: 9px 25px; cursor: pointer; }

        #icon-tray { display: flex; justify-content: center; gap: 28px; margin-top: 10px; }
        .tray-icon { width: 20px; height: 20px; cursor: pointer; opacity: 0.5; filter: invert(1); transition: 0.2s; }
        .tray-icon.active { filter: none; opacity: 1; background: #f5d300; border-radius: 50%; padding: 5px; }

        /* AUTH BOX */
        .auth-container { position: absolute; inset: 0; background: radial-gradient(circle, #001a33, #000); display: flex; align-items: center; justify-content: center; z-index: 200; }
        .auth-box { width: 320px; padding: 40px; background: rgba(0,0,0,0.8); border: 1px solid #00e5ff; border-radius: 12px; text-align: center; }
        .auth-input { width: 90%; padding: 12px; margin-bottom: 20px; background: #000; border: 1px solid #333; color: white; text-align: center; }
        .auth-btn { width: 100%; padding: 14px; background: #00e5ff; border: none; font-weight: bold; cursor: pointer; color: #000; }
    </style>
</head>
<body>

    <div id="login-view" class="auth-container">
        <div class="auth-box">
            <h1 style="color:#00e5ff; font-size: 20px;">ROBOT WORLD</h1>
            <input type="text" id="login-user" class="auth-input" placeholder="Enter Name">
            <button class="auth-btn" onclick="enterRoom()">JOIN GRID</button>
        </div>
    </div>

    <div id="room-view" style="display:none;">
        <div id="canvas-container" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
        <div id="ui-layer">
            <div id="chat-history"></div>
            <div id="imvu-bottom-bar">
                <div id="input-row">
                    <input type="text" id="msgInput" placeholder="Chat here..." autocomplete="off">
                    <button id="send-btn" onclick="sendMsg()">Send</button>
                </div>
                <div id="icon-tray">
                    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" class="tray-icon active">
                    <img src="https://cdn-icons-png.flaticon.com/512/3159/3159620.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/1067/1067555.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/2800/2800458.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" class="tray-icon">
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = "Guest";
        const avatars = {};

        function enterRoom() {
            currentUser = document.getElementById('login-user').value || "Guest";
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('room-view').style.display = 'block';
            socket.emit('join game', currentUser);
            animate();
        }

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2.5, 7);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(5, 10, 5);
        scene.add(sun);
        const rim = new THREE.PointLight(0x00e5ff, 2, 20);
        rim.position.set(-5, 5, -5);
        scene.add(rim);

        scene.add(new THREE.GridHelper(50, 50, 0x00e5ff, 0x0a0a0a));

        const loader = new THREE.GLTFLoader();

        function spawnAvatar(id, data) {
            if(avatars[id]) return;

            loader.load('models/male_avatar.glb', (gltf) => {
                const model = gltf.scene;
                model.scale.set(0.01, 0.01, 0.01); 
                model.position.set(data.x || 0, 0, data.z || 0);

                const bones = {};
                model.traverse(node => {
                    if (node.isBone) {
                        const name = node.name.toLowerCase();
                        // Search for common bone names (Blender/Mixamo/standard glTF)
                        if (name.includes('head')) bones.head = node;
                        if (name.includes('neck')) bones.neck = node;
                        if (name.includes('hips') || name.includes('pelvis')) bones.hips = node;
                        if (name.includes('spine')) bones.spine = node;
                        // Shoulder/Arm detection to fix T-pose
                        if (name.includes('arm') || name.includes('shoulder')) {
                            if (name.includes('l') || name.includes('left')) {
                                if (!bones.armsL) bones.armsL = [];
                                bones.armsL.push(node);
                            } else {
                                if (!bones.armsR) bones.armsR = [];
                                bones.armsR.push(node);
                            }
                        }
                    }
                });

                scene.add(model);
                avatars[id] = { mesh: model, bones: bones, seed: Math.random() * 50 };
            });
        }

        // --- NEW PROCEDURAL ANIMATION (HEAD MOVE + ARM DOWN) ---
        function updateAvatarAnimation(avatar, time) {
            if (!avatar.mesh || !avatar.bones) return;
            const b = avatar.bones;
            const t = time + avatar.seed;

            // 1. T-POSE FIX (Forcing Arms Down)
            // We rotate the topmost arm bone (shoulder/upper arm) down significantly
            if (b.armsL) {
                b.armsL.forEach(bone => {
                    // Arm down on Z axis for standard models, with a little breathing bounce
                    bone.rotation.z = 1.4 + Math.sin(t * 1.5) * 0.02; 
                    bone.rotation.x = 0.2; 
                });
            }
            if (b.armsR) {
                b.armsR.forEach(bone => {
                    bone.rotation.z = -1.4 - Math.sin(t * 1.5) * 0.02;
                    bone.rotation.x = 0.2;
                });
            }

            // 2. HEAD MOVEMENT (Looking Around)
            // We use two sine waves at different speeds to make it look non-robotic
            if (b.head || b.neck) {
                const target = b.head || b.neck;
                // Horizontal look (Y axis) - slow sway + fast subtle twitches
                target.rotation.y = (Math.sin(t * 0.4) * 0.4) + (Math.sin(t * 2.1) * 0.05);
                // Vertical look (X axis)
                target.rotation.x = (Math.cos(t * 0.3) * 0.1) + (Math.sin(t * 1.8) * 0.02);
            }

            // 3. BODY WEIGHT SHIFT (Classic IMVU Style)
            if (b.hips) {
                b.hips.rotation.z = Math.sin(t * 0.7) * 0.08; // Hip sway
                b.hips.position.x = Math.sin(t * 0.7) * 0.03; 
            }
            if (b.spine) {
                b.spine.rotation.x = (Math.sin(t * 1.5) * 0.04) + 0.05; // Breathing
                b.spine.rotation.y = Math.cos(t * 0.7) * 0.05; // Torso sway
            }

            // 4. GENTLE HOVERING
            avatar.mesh.position.y = Math.sin(t * 1.2) * 0.04;
        }

        const clock = new THREE.Clock();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        function animate() {
            requestAnimationFrame(animate);
            const elapsed = clock.getElapsedTime();
            for(let id in avatars) {
                updateAvatarAnimation(avatars[id], elapsed);
            }
            controls.update();
            renderer.render(scene, camera);
        }

        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(val) {
                socket.emit('chat message', { username: currentUser, message: val });
                document.getElementById('msgInput').value = '';
            }
        }

        socket.on('chat message', (data) => {
            const hist = document.getElementById('chat-history');
            const line = document.createElement('div');
            line.className = 'chat-line';
            line.innerHTML = `<span class="username">${data.username}:</span> <span>${data.message}</span>`;
            hist.appendChild(line);
            hist.scrollTop = hist.scrollHeight;
        });

        socket.on('init players', (p) => { for(let id in p) spawnAvatar(id, p[id]); });
        socket.on('new player', (p) => spawnAvatar(p.id, p));

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('msgInput').addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMsg();
        });
    </script>
</body>
</html>
