<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Blender Fix</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #050510; font-family: 'Segoe UI', Arial, sans-serif; color: white; }
        #ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        
        /* SOLID BLACK CHAT */
        #chat-history { 
            height: 220px; overflow-y: auto; padding: 15px 25px; 
            background: #000000 !important; pointer-events: auto; font-size: 14px; 
            border-top: 2px solid #111;
        }
        .username { color: #f5d300; font-weight: bold; margin-right: 8px; }

        /* YELLOW BAR */
        #imvu-bottom-bar { background: #000; border-top: 1px solid #f5d300; padding: 12px 0; pointer-events: auto; }
        #input-row { display: flex; align-items: center; padding: 0 15px; gap: 10px; }
        #msgInput { flex-grow: 1; background: #080808; border: 1px solid #333; color: #fff; padding: 10px; outline: none; }
        #send-btn { background: #f5d300; color: #000; border: none; font-weight: bold; padding: 10px 30px; cursor: pointer; }

        #icon-tray { display: flex; justify-content: center; gap: 30px; margin-top: 12px; }
        .tray-icon { width: 20px; height: 20px; filter: invert(1); opacity: 0.4; }
    </style>
</head>
<body>

    <div id="room-view">
        <div id="canvas-container" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
        <div id="ui-layer">
            <div id="chat-history"></div>
            <div id="imvu-bottom-bar">
                <div id="input-row">
                    <input type="text" id="msgInput" placeholder="Chat..." autocomplete="off">
                    <button id="send-btn" onclick="sendMsg()">Send</button>
                </div>
                <div id="icon-tray">
                    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" style="opacity:1; filter:none; background:#f5d300; border-radius:50%; padding:5px; width:20px;">
                    <img src="https://cdn-icons-png.flaticon.com/512/3159/3159620.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/1067/1067555.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/2800/2800458.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png" class="tray-icon">
                    <img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" class="tray-icon">
                </div>
            </div>
        </div>
    </div>

    <script>
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 6);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 1.2, 0);

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(5, 10, 5);
        scene.add(sun);
        scene.add(new THREE.GridHelper(50, 50, 0x00e5ff, 0x0a0a0a));

        const avatars = {};
        const loader = new THREE.GLTFLoader();

        function spawnAvatar(id) {
            loader.load('models/male_avatar.glb', (gltf) => {
                const model = gltf.scene;
                // Standard scaling for Blender exports
                model.scale.set(1, 1, 1); 
                
                const bones = { armsL: [], armsR: [], eyes: [] };
                
                // --- DEEP SCAN FOR BLENDER BONES ---
                model.traverse(n => {
                    if (n.isBone) {
                        const name = n.name.toLowerCase();
                        console.log("Found Bone:", n.name); // Check your F12 console to see these!

                        if (name.includes('head')) bones.head = n;
                        if (name.includes('eye')) bones.eyes.push(n);
                        if (name.includes('hips') || name.includes('pelvis')) bones.hips = n;
                        if (name.includes('spine')) bones.spine = n;
                        
                        // Find shoulders/arms (Blender standard)
                        if (name.includes('shoulder') || name.includes('arm')) {
                            if (name.includes('l')) bones.armsL.push(n);
                            else bones.armsR.push(n);
                        }
                    }
                });

                scene.add(model);
                avatars[id] = { mesh: model, bones, seed: Math.random() * 10 };
            });
        }

        function updateAnimation(avatar, time) {
            if (!avatar.bones) return;
            const b = avatar.bones;
            const t = time + avatar.seed;

            // 1. POSE FIX (Blender Arms usually use X or Z for "Down")
            // We apply a rotation that forces them down
            if(b.armsL.length > 0) {
                b.armsL[0].rotation.z = 1.4; // Drops shoulder
                b.armsL[0].rotation.x = 0.2; // Move slightly forward
            }
            if(b.armsR.length > 0) {
                b.armsR[0].rotation.z = -1.4;
                b.armsR[0].rotation.x = 0.2;
            }

            // 2. IMVU WEIGHT SHIFT (The Hip Sway)
            if (b.hips) {
                // Rotation on Z creates the side-leaning effect
                b.hips.rotation.z = Math.sin(t * 0.8) * 0.15; 
                // Position X shift creates the physical weight move
                b.hips.position.x = Math.sin(t * 0.8) * 0.05; 
            }

            // 3. SPINE BREATHING
            if (b.spine) {
                b.spine.rotation.x = (Math.sin(t * 1.5) * 0.04) + 0.05;
                b.spine.rotation.z = -Math.sin(t * 0.8) * 0.05; // Counter sway
            }

            // 4. NATURAL HEAD MOVEMENT
            if (b.head) {
                b.head.rotation.y = Math.sin(t * 0.5) * 0.4 + Math.sin(t * 2) * 0.05;
                b.head.rotation.x = Math.cos(t * 0.4) * 0.1;
            }

            // 5. EYE FLICKER
            b.eyes.forEach(eye => {
                eye.rotation.y = Math.sin(t * 0.3) * 0.1;
            });

            // 6. GENTLE HOVER
            avatar.mesh.position.y = Math.sin(t * 1.2) * 0.05;
        }

        // Spawn test
        spawnAvatar('local');

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() / 1000;
            for (let id in avatars) updateAnimation(avatars[id], time);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            const hist = document.getElementById('chat-history');
            hist.innerHTML += `<div style="margin-bottom:8px;"><span class="username">You:</span> ${val}</div>`;
            hist.scrollTop = hist.scrollHeight;
            document.getElementById('msgInput').value = '';
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
