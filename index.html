<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IMVU Clone - Fixed Robots & Yellow Chat</title>
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        /* --- GLOBAL RESET --- */
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: 'Verdana', sans-serif; color: white; }
        button { cursor: pointer; } input { outline: none; } a { text-decoration: none; color: #ffd700; }

        /* --- VIEW MANAGEMENT --- */
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 10; }
        #login-view { display: flex; z-index: 50; } 

        /* --- AUTH --- */
        .auth-container { background: linear-gradient(135deg, #1a1a1a, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-box { width: 300px; padding: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid #444; border-radius: 8px; text-align: center; }
        .auth-input { width: 90%; padding: 10px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; }
        .auth-btn { width: 100%; padding: 10px; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); border: none; font-weight: bold; color: black; border-radius: 4px; cursor: pointer; }
        .link-text { margin-top: 20px; font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff5555; font-size: 12px; margin-bottom: 10px; display: none; }

        /* --- DASHBOARD --- */
        #dashboard-view { background: #222; }
        .imvu-navbar { width: 100%; height: 50px; background: #000; border-bottom: 3px solid #ffd700; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; }
        .nav-logo { font-size: 24px; font-weight: bold; color: white; margin-right: 30px; }
        .nav-item { color: #ccc; margin-right: 20px; font-size: 14px; cursor: pointer; }
        .dash-content { height: calc(100% - 50px); display: flex; justify-content: center; align-items: center; background: url('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg') center/cover; }
        .big-btn { width: 200px; height: 150px; background: linear-gradient(to bottom, #444, #222); border: 2px solid #555; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .big-btn:hover { border-color: #ffd700; transform: scale(1.05); transition: 0.2s; }
        .big-icon { font-size: 40px; margin-bottom: 10px; }

        /* --- ROOM BROWSER --- */
        #room-list-view { background: #333; display: none; flex-direction: column; }
        .browser-header { height: 40px; background: linear-gradient(to bottom, #555, #333); display: flex; align-items: flex-end; padding-left: 10px; border-bottom: 1px solid #000; }
        .browser-tab { padding: 8px 20px; background: #ffd700; color: black; font-weight: bold; font-size: 12px; border-radius: 5px 5px 0 0; margin-right: 5px; }
        .browser-body { flex-grow: 1; display: flex; background: #222; overflow: hidden; }
        .sidebar { width: 220px; background: #1a1a1a; border-right: 1px solid #000; padding: 10px; }
        .rooms-grid { flex-grow: 1; padding: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; overflow-y: auto; }
        .room-listing { width: 350px; height: 120px; background: #111; border: 1px solid #444; display: flex; cursor: pointer; }
        .room-listing:hover { border-color: #ffd700; }
        .listing-thumb { width: 140px; background: #000; }
        .listing-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .listing-info { padding: 10px; }

        /* --- ROOM CARD --- */
        #room-card-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; display: none; align-items: center; justify-content: center; }
        .imvu-room-card { width: 600px; background: #f0f0f0; border: 1px solid #000; box-shadow: 0 0 20px rgba(0,0,0,0.8); color: #000; font-family: 'Verdana', sans-serif; font-size: 11px; display: flex; flex-direction: column; }
        .card-header { background: linear-gradient(to bottom, #444, #222); padding: 5px; color: white; display: flex; }
        .card-thumb { width: 180px; height: 110px; background: #000; border: 1px solid #666; margin-right: 10px; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .card-details { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 14px; color: #fff; margin-bottom: 5px; }
        .card-rating { margin-top: 10px; color: #ffd700; font-size: 16px; cursor: default; } 
        .close-card { margin-left: auto; cursor: pointer; font-weight: bold; font-size: 14px; color: #aaa; }
        .card-body { padding: 10px; background: #f9f9f9; }
        .occupants-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; }
        .occupants-table th { background: #fff; text-align: left; padding: 4px; border-bottom: 1px solid #ccc; color: #999; font-weight: normal; font-size: 10px; }
        .occupants-table td { padding: 4px; font-size: 11px; color: #333; }
        .occupants-table tr:nth-child(even) { background: #f0f0f0; }
        .card-footer { background: #eee; padding: 8px; border-top: 1px solid #ccc; display: flex; align-items: center; justify-content: space-between; }
        .go-btn-large { background: linear-gradient(to bottom, #ffd700, #ffb300); border: 1px solid #886600; color: black; font-weight: bold; padding: 5px 30px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 2px rgba(0,0,0,0.2); }

        /* --- 3D SCENE --- */
        #room-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; }
        #canvas-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; background: #000; }
        
        #scene-header { position: absolute; top: 10px; left: 10px; z-index: 150; display: flex; gap: 5px; }
        #scene-rating-box { background: rgba(0,0,0,0.6); padding: 5px; border: 1px solid #555; color: white; font-size: 10px; display: flex; align-items: center; }
        .mini-stars { color: #555; cursor: pointer; margin-left: 5px; font-size: 14px; }
        .mini-stars.active { color: #ffd700; }
        #info-btn { width: 26px; height: 26px; background: linear-gradient(to bottom, #fff, #ccc); border: 1px solid #999; border-radius: 50%; color: black; font-weight: bold; font-family: serif; font-size: 14px; font-style: italic; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        #exit-btn { position: absolute; top: 15px; right: 15px; background: #d32f2f; color: white; border: 1px solid #fff; padding: 5px 10px; font-weight: bold; font-size: 12px; z-index: 200; cursor: pointer; }

        /* --- AUTHENTIC YELLOW CHATBOX --- */
        #ui-layer { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; 
            z-index: 300; pointer-events: none; 
            display: flex; flex-direction: column; justify-content: flex-end; 
        }
        
        #imvu-chat-panel { 
            pointer-events: auto; width: 100%; 
            display: flex; flex-direction: column; 
            height: 240px; 
            transition: height 0.3s;
        }

        /* 1. History Area */
        #chat-interface-wrapper { 
            flex-grow: 1; 
            background-color: rgba(0, 0, 0, 0.9); 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            border-top: 2px solid #444;
        }
        #chat-history { 
            flex-grow: 1; overflow-y: auto; padding: 5px; 
            font-size: 13px; line-height: 1.5; color: white; 
            scrollbar-width: thin; scrollbar-color: #ffd700 #111; 
        }

        /* INSTANT ANIMATION FOR SPAM */
        .chat-line { 
            margin-bottom: 4px; display: block; 
            font-family: 'Verdana', sans-serif;
            animation: none; /* Instant */
        }

        .username { color: #8FBC8F; font-weight: bold; cursor: pointer; margin-right: 5px; }
        .message-text { color: #e0e0e0; }
        .system-msg { color: #ffd700; font-style: italic; font-weight: bold; font-size: 11px; }

        /* 2. Input Bar (Dark Grey) */
        #input-row { 
            height: 35px; background: #1a1a1a; 
            display: flex; align-items: center; padding: 0 5px; 
            flex-shrink: 0; border-top: 1px solid #333;
        }
        #msgInput { flex-grow: 1; background: #000; border: 1px solid #444; color: white; padding: 6px; font-size: 12px; height: 18px; margin-right: 5px; }
        #send-btn { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 1px solid #c49000; font-weight: bold; font-size: 11px; padding: 4px 20px; cursor: pointer; height: 28px; }

        /* 3. Toolbar (Yellow Divider + Icons) */
        #toolbar { 
            height: 40px; background-color: #000; 
            border-top: 3px solid #ffd700; 
            display: flex; align-items: center; 
            padding-left: 10px; gap: 15px;
            flex-shrink: 0; 
        }
        .icon { font-size: 20px; cursor: pointer; filter: grayscale(100%); transition: 0.2s; }
        .icon:hover { filter: grayscale(0%); }
        .icon.active { filter: grayscale(0%); color: #ffd700; text-shadow: 0 0 5px #ffd700; }

        /* 4. Bubbles */
        .chat-bubble { position: absolute; background: white; color: black; padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 2px 2px 0px rgba(0,0,0,0.3); border: 1px solid #000; pointer-events: none; white-space: nowrap; z-index: 120; animation: floatUp 2.5s forwards; transform-origin: center bottom; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 0; } 10% { transform: translateY(-10px) scale(1.05); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-80px) scale(0.9); opacity: 0; } }
        
        #avatar-menu { display: none; position: absolute; width: 150px; background-color: rgba(0, 0, 0, 0.9); border: 1px solid #555; font-size: 12px; z-index: 150; pointer-events: auto; color: #ddd; }
        .action-item { padding: 5px 10px; cursor: pointer; border-bottom: 1px solid #222; } .action-item:hover { background: #333; }
    </style>
</head>
<body>

    <!-- AUTH VIEWS -->
    <div id="login-view" class="view-section auth-container">
        <div class="auth-box">
            <h2 style="color:#ffd700; margin-bottom:10px;">IMVU Classic</h2>
            <div id="login-error" class="error-msg">Invalid credentials</div>
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleLogin()">Sign In</button>
            <div class="link-text" onclick="showSignup()">Sign Up</div>
        </div>
    </div>
    <div id="signup-view" class="view-section auth-container">
        <div class="auth-box">
            <h2 style="color:#ffd700; margin-bottom:10px;">Register</h2>
            <div id="signup-error" class="error-msg">Taken</div>
            <input type="text" id="signup-user" class="auth-input" placeholder="Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="handleSignup()">Register</button>
            <div class="link-text" onclick="showLogin()">Back to Login</div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view" class="view-section">
        <div class="imvu-navbar"><div class="nav-logo">IMVU</div><div class="nav-item">Home</div></div>
        <div class="dash-content">
            <div class="big-btn" onclick="openRoomBrowser()"><div class="big-icon">üí¨</div><div class="big-text">Chat Rooms</div></div>
        </div>
    </div>

    <!-- ROOM BROWSER -->
    <div id="room-list-view" class="view-section">
        <div class="browser-header"><div class="browser-tab">Search</div></div>
        <div class="browser-body">
            <div class="sidebar"><div class="sidebar-title">Room Type</div><select class="filter-select"><option>All</option></select></div>
            <div class="rooms-grid">
                <div class="room-listing" onclick="openRoomCard(false)">
                    <div class="listing-thumb"><img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" style="width:100%;height:100%;object-fit:cover;"></div>
                    <div class="listing-info">
                        <div class="listing-name">Robot Lounge</div>
                        <div class="listing-author">by Admin</div>
                        <div style="color:#ffd700; font-size:10px;" id="listing-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROOM CARD -->
    <div id="room-card-overlay">
        <div class="imvu-room-card">
            <div class="card-header">
                <div class="card-thumb"><img src="https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg" style="width:100%;height:100%;object-fit:cover;"></div>
                <div class="card-details">
                    <div class="card-title">Robot Lounge ... *Chill*</div>
                    <div style="color:#ffd700;">by Admin</div>
                    <div class="card-rating">Rating: <span id="card-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span> <span style="font-size:10px; color:#fff;" id="rating-text">(0/5)</span></div>
                </div>
                <div class="close-card" onclick="closeRoomCard()">‚úñ</div>
            </div>
            <div class="card-body">
                <div class="section-label">occupants</div>
                <table class="occupants-table">
                    <thead><tr><th>name</th><th>gender</th><th>size</th><th></th></tr></thead>
                    <tbody id="occupant-list"></tbody>
                </table>
            </div>
            <div class="card-footer"><button class="go-btn-large" id="card-go-btn" onclick="enterRoom()">Go</button></div>
        </div>
    </div>

    <!-- 3D ROOM -->
    <div id="room-view" class="view-section">
        <div id="scene-header">
            <div id="scene-rating-box">Rate: <span id="scene-stars" class="mini-stars" onclick="rateRoom(event)">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span></div>
            <div id="info-btn" onclick="openRoomCard(true)">i</div>
        </div>
        <div id="canvas-container"></div>
        <div id="avatar-menu">
            <div class="action-item" onclick="closeAvatarMenu()">View Profile</div>
            <div class="action-item" onclick="closeAvatarMenu()">Whisper</div>
        </div>
        <button id="exit-btn" onclick="exitRoom()">‚úñ EXIT ROOM</button>
        
        <!-- AUTHENTIC YELLOW CHATBOX -->
        <div id="ui-layer">
            <div id="imvu-chat-panel">
                <div id="chat-interface-wrapper"><div id="chat-history"></div></div>
                <div id="input-row">
                    <input type="text" id="msgInput" placeholder="" autocomplete="off">
                    <button id="send-btn" onclick="sendMsg()">Send</button>
                </div>
                <div id="toolbar">
                    <div class="icon active" id="chat-icon" onclick="toggleChatWindow()">üí¨</div>
                    <div class="icon">üëï</div>
                    <div class="icon">üß•</div>
                    <div class="icon">ü™ë</div>
                    <div class="icon">üè†</div>
                    <div class="icon">üéµ</div>
                    <div class="icon">üì∑</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser="Guest", mySocketId=null, roomPlayers={}, isInRoom=false;
        let currentRating = parseInt(localStorage.getItem('room_rating')) || 0;

        socket.on('connect', () => { mySocketId = socket.id; });

        // AUTH
        function getLocalUsers(){ return JSON.parse(localStorage.getItem('imvu_users')||'{}'); }
        function switchView(id){ document.querySelectorAll('.view-section').forEach(el=>el.style.display='none'); document.getElementById(id).style.display='flex'; if(id==='dashboard-view'||id==='room-view')document.getElementById(id).style.display='block'; }
        function showSignup(){ switchView('signup-view'); }
        function showLogin(){ switchView('login-view'); }
        
        async function handleSignup(){
            const u=document.getElementById('signup-user').value.trim(), p=document.getElementById('signup-pass').value.trim();
            if(!u||!p)return; const users=getLocalUsers(); if(users[u]){document.getElementById('signup-error').style.display='block';return;}
            users[u]=p; localStorage.setItem('imvu_users',JSON.stringify(users)); showLogin();
        }
        async function handleLogin(){
            const u=document.getElementById('login-user').value.trim(), p=document.getElementById('login-pass').value.trim();
            const users=getLocalUsers(); if(users[u]===p){ currentUser=u; switchView('dashboard-view'); }
            else{document.getElementById('login-error').style.display='block';}
        }

        // ROOM LOGIC
        function openRoomBrowser(){ switchView('room-list-view'); document.getElementById('room-list-view').style.display='flex'; updateStarsDisplay(currentRating); }
        function openRoomCard(fromInside){
            const tbody=document.getElementById('occupant-list'); tbody.innerHTML="";
            const meRow=`<tr style="background:#ffffcc;"><td><span style="font-size:12px;">üá∫üá∏</span> <u>${currentUser}</u></td><td>hidden</td><td>4,200 kb</td><td>(You)</td></tr>`;
            if(!isInRoom){ tbody.innerHTML=meRow; document.getElementById('card-go-btn').style.display='block'; }
            else{ document.getElementById('card-go-btn').style.display='none'; tbody.innerHTML+=meRow; for(let id in roomPlayers){ if(id!==mySocketId){ tbody.innerHTML+=`<tr><td><span style="font-size:12px;">üè≥Ô∏è</span> <u>${roomPlayers[id].username}</u></td><td>?</td><td>5,000 kb</td><td></td></tr>`; }}}
            updateStarsDisplay(currentRating); document.getElementById('room-card-overlay').style.display='flex';
        }
        function closeRoomCard(){ document.getElementById('room-card-overlay').style.display='none'; }
        function rateRoom(e){ e.stopPropagation(); if(currentRating<5)currentRating++;else currentRating=0; localStorage.setItem('room_rating',currentRating); updateStarsDisplay(currentRating); }
        function updateStarsDisplay(r){ const s="‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".substring(0,r)+"‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".substring(0,5-r); document.getElementById('card-stars').innerText=s; document.getElementById('rating-text').innerText=`(${r}/5)`; document.getElementById('scene-stars').innerText=s; document.getElementById('scene-stars').className=r>0?"mini-stars active":"mini-stars"; document.getElementById('listing-stars').innerText=s; }
        
        function enterRoom(){ closeRoomCard(); isInRoom=true; switchView('room-view'); onWindowResize(); socket.emit('join game',currentUser); }
        function exitRoom(){ isInRoom=false; switchView('room-list-view'); document.getElementById('room-list-view').style.display='flex'; }

        // CHAT (INSTANT SPAM)
        let isChatOpen=true;
        function toggleChatWindow(){
            const w=document.getElementById('chat-interface-wrapper'), r=document.getElementById('input-row'), p=document.getElementById('imvu-chat-panel');
            if(isChatOpen){ w.style.display='none'; r.style.display='none'; p.style.height='45px'; isChatOpen=false; document.getElementById('chat-icon').classList.remove('active'); }
            else{ w.style.display='flex'; r.style.display='flex'; p.style.height='240px'; isChatOpen=true; document.getElementById('chat-icon').classList.add('active'); }
        }

        const chatBox=document.getElementById('chat-history'); const input=document.getElementById('msgInput');
        socket.on('chat message',(d)=>{ renderChatLine('chat',d.username,d.message); });
        socket.on('system message',(m)=>{ renderChatLine('system',null,m); });

        function renderChatLine(type, username, text) {
            const msgDiv = document.createElement('div'); msgDiv.className = 'chat-line';
            if(type==='system') msgDiv.innerHTML=`<span class="system-msg">*** ${text} ***</span>`;
            else {
                msgDiv.innerHTML=`<span class="username">${username}:</span> <span class="message-text">${text}</span>`;
                // INSTANT BUBBLES - NO THROTTLE
                createChatBubble(username, text);
            }
            chatBox.appendChild(msgDiv);
            
            // Allow more messages before cutting off (better for spam flow)
            if(chatBox.childElementCount > 100) {
                chatBox.removeChild(chatBox.firstChild);
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function sendMsg(){ if(input.value){ socket.emit('chat message',{username:currentUser,message:input.value}); input.value=''; } }
        input.addEventListener("keydown",(e)=>{if(e.key==="Enter")sendMsg();});

        // 3D SCENE
        const container=document.getElementById('canvas-container'); 
        const scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000); scene.fog=new THREE.Fog(0x000000,10,50);
        const camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,100); camera.position.set(0,8,15);
        const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true; 
        
        if(container.hasChildNodes()) container.innerHTML = '';
        container.appendChild(renderer.domElement);
        
        const hemiLight=new THREE.HemisphereLight(0xffffff,0x444444,0.6); hemiLight.position.set(0,20,0); scene.add(hemiLight);
        const dirLight=new THREE.DirectionalLight(0xffffff,0.8); dirLight.position.set(10,20,10); dirLight.castShadow=true; dirLight.shadow.mapSize.width=1024; dirLight.shadow.mapSize.height=1024; scene.add(dirLight);

        const texLoader=new THREE.TextureLoader(); const leatherTex=texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/disturb.jpg'); leatherTex.wrapS=leatherTex.wrapT=THREE.RepeatWrapping; leatherTex.repeat.set(2,2);
        const grid=new THREE.GridHelper(100,100,0xffff00,0x222222); grid.position.y=0.01; grid.material.opacity=0.2; grid.material.transparent=true; scene.add(grid);
        const floor=new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({color:0x080810,roughness:0.8})); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

        const couchGroup=new THREE.Group(); const couchMat=new THREE.MeshStandardMaterial({map:leatherTex,color:0x8B4513,roughness:0.6});
        const seat=new THREE.Mesh(new THREE.BoxGeometry(8,1,3),couchMat); seat.position.y=0.5; seat.castShadow=true; seat.receiveShadow=true; couchGroup.add(seat);
        const back=new THREE.Mesh(new THREE.BoxGeometry(8,2,0.5),couchMat); back.position.y=1.5; back.position.z=-1.25; back.castShadow=true; couchGroup.add(back);
        const armL=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,3),couchMat); armL.position.set(-4.5,0.75,0); armL.castShadow=true; couchGroup.add(armL);
        const armR=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,3),couchMat); armR.position.set(4.5,0.75,0); armR.castShadow=true; couchGroup.add(armR);
        couchGroup.position.set(0,0,-5); scene.add(couchGroup);

        const avatars={}; const loader=new THREE.GLTFLoader();
        socket.on('init players',(p)=>{ roomPlayers=p; for(let id in p)spawnAvatar(id,p[id]); if(document.getElementById('room-card-overlay').style.display==='flex' && isInRoom)openRoomCard(true); });
        socket.on('new player',(p)=>{ roomPlayers[p.id]=p; spawnAvatar(p.id,p); if(document.getElementById('room-card-overlay').style.display==='flex' && isInRoom)openRoomCard(true); });
        socket.on('remove player',(id)=>{ delete roomPlayers[id]; if(avatars[id]){scene.remove(avatars[id].mesh);delete avatars[id];} if(document.getElementById('room-card-overlay').style.display==='flex' && isInRoom)openRoomCard(true); });
        socket.on('player moved',(d)=>{ if(avatars[d.id]){ const av=avatars[d.id]; av.target.set(d.x,0,d.z); av.mesh.lookAt(d.x,0,d.z); if(av.action!=='Walking'){ if(av.actions['Idle'])av.actions['Idle'].fadeOut(0.2); if(av.actions['Sitting'])av.actions['Sitting'].fadeOut(0.2); if(av.actions['Walking'])av.actions['Walking'].reset().fadeIn(0.2).play(); av.action='Walking'; } } });

        function spawnAvatar(id,d){ 
            if(avatars[id])return; 
            loader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/models/gltf/RobotExpressive/RobotExpressive.glb',(gltf)=>{ 
                const m=gltf.scene; m.scale.set(0.4,0.4,0.4); m.position.set(d.x,0,d.z); 
                m.traverse((o)=>{if(o.isMesh){o.castShadow=true;o.receiveShadow=true;}}); 
                m.userData={username:d.username,socketId:id}; 
                scene.add(m); 
                const mixer=new THREE.AnimationMixer(m); const actions={}; 
                ['Idle','Walking','Sitting'].forEach(n=>{const c=THREE.AnimationClip.findByName(gltf.animations,n);if(c)actions[n]=mixer.clipAction(c);}); 
                if(actions['Idle'])actions['Idle'].play(); 
                avatars[id]={mesh:m,mixer,actions,action:'Idle',target:new THREE.Vector3(d.x,0,d.z)}; 
                if(id===mySocketId)renderChatLine('system',null,"You have entered the room."); else renderChatLine('system',null,`${d.username} has joined.`); 
            }); 
        }
        
        function createChatBubble(u,t){ let s=null; for(let id in avatars)if(avatars[id].mesh.userData.username===u)s=avatars[id].mesh; if(!s)return; const p=s.position.clone().add(new THREE.Vector3(0,2,0)); p.project(camera); const x=(p.x*.5+.5)*window.innerWidth; const y=(-(p.y*.5)+.5)*window.innerHeight; const b=document.createElement('div'); b.className='chat-bubble'; b.innerText=t; b.style.left=x+'px'; b.style.top=y+'px'; document.getElementById('room-view').appendChild(b); setTimeout(()=>b.remove(),2500); }

        const raycaster=new THREE.Raycaster(); const mouse=new THREE.Vector2(); const nodes=[]; const seats=[];
        function createNode(x,z,t='walk',y=0.05){ const g=new THREE.CylinderGeometry(t==='seat'?0.4:1,t==='seat'?0.4:1,0.1,16); const m=new THREE.MeshBasicMaterial({color:0xffff00,opacity:0.4,transparent:true}); const n=new THREE.Mesh(g,m); n.position.set(x,y,z); n.userData={type:t,x,z}; scene.add(n); nodes.push(n); if(t==='seat')seats.push(n); }
        createNode(-5,5); createNode(5,5); createNode(0,0); createNode(-5,-5); createNode(5,-5); createNode(-2,-5,'seat',0.6); createNode(2,-5,'seat',0.6);

        renderer.domElement.addEventListener('pointerdown',(e)=>{ if(document.getElementById('room-view').style.display==='none'||document.getElementById('room-card-overlay').style.display==='flex')return; const r=renderer.domElement.getBoundingClientRect(); mouse.x=((e.clientX-r.left)/r.width)*2-1; mouse.y=-((e.clientY-r.top)/r.height)*2+1; raycaster.setFromCamera(mouse,camera); const n=raycaster.intersectObjects(nodes); if(n.length>0){const d=n[0].object.userData; socket.emit('move',{x:d.x,z:d.z}); closeAvatarMenu(); return;} const am=[]; for(let id in avatars)am.push(avatars[id].mesh); let ha=null; const i=raycaster.intersectObjects(am,true); if(i.length>0){let o=i[0].object; while(o.parent&&o.parent!==scene){if(o.userData&&o.userData.username){ha=o;break;}o=o.parent;} if(!ha&&o.userData.username)ha=o;} if(ha){const m=document.getElementById('avatar-menu'); m.style.display='block'; m.style.left=e.clientX+'px'; m.style.top=e.clientY+'px';}else{closeAvatarMenu();} });
        function closeAvatarMenu(){document.getElementById('avatar-menu').style.display='none';}
        window.onresize=()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);};
        const clock=new THREE.Clock(); const controls=new THREE.OrbitControls(camera,renderer.domElement); controls.enableDamping=true; controls.dampingFactor=0.05; controls.maxPolarAngle=Math.PI/2-0.1;
        function animate(){ requestAnimationFrame(animate); if(document.getElementById('room-view').style.display!=='none'){ const d=clock.getDelta(); for(let id in avatars){ const av=avatars[id]; if(av.mixer)av.mixer.update(d); if(av.mesh.position.distanceTo(av.target)>0.1){ av.mesh.position.lerp(av.target,0.05); }else if(av.action==='Walking'){ if(id===mySocketId)socket.emit('stop move'); let s=false; for(let st of seats){if(Math.hypot(av.mesh.position.x-st.position.x,av.mesh.position.z-st.position.z)<0.5)s=true;} if(av.actions['Walking'])av.actions['Walking'].fadeOut(0.2); if(s){if(av.actions['Sitting'])av.actions['Sitting'].reset().fadeIn(0.2).play();av.action='Sitting';av.mesh.rotation.y=Math.PI;}else{if(av.actions['Idle'])av.actions['Idle'].reset().fadeIn(0.2).play();av.action='Idle';} } } controls.update(); renderer.render(scene,camera); } }
        animate();
    </script>
</body>
</html>
